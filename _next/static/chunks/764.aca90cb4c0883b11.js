"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[764],{33952:(e,t,i)=>{i.d(t,{j9:()=>v,Wg:()=>F});class a{blockPosition;dataPosition;constructor(e,t){this.blockPosition=e,this.dataPosition=t}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(e){return this.blockPosition-e.blockPosition||this.dataPosition-e.dataPosition}static min(...e){let t;let i=0;for(;!t;i+=1)t=e[i];for(;i<e.length;i+=1)t.compareTo(e[i])>0&&(t=e[i]);return t}}function r(e,t=0,i=!1){if(i)throw Error("big-endian virtual file offsets not implemented");return new a(0x10000000000*e[t+7]+0x100000000*e[t+6]+0x1000000*e[t+5]+65536*e[t+4]+256*e[t+3]+e[t+2],e[t+1]<<8|e[t])}class s{minv;maxv;bin;_fetchedSize;buffer;constructor(e,t,i,a){this.minv=e,this.maxv=t,this.bin=i,this._fetchedSize=a}toUniqueString(){return`${this.minv.toString()}..${this.maxv.toString()} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(e){return this.minv.compareTo(e.minv)||this.maxv.compareTo(e.maxv)||this.bin-e.bin}fetchedSize(){return void 0!==this._fetchedSize?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}function n(e,t){let i;let a=[];if(0===e.length)return e;for(let s of(e.sort((e,t)=>{let i=e.minv.blockPosition-t.minv.blockPosition;return 0===i?e.minv.dataPosition-t.minv.dataPosition:i}),e))if(!t||s.maxv.compareTo(t)>0){if(void 0===i)a.push(s),i=s;else{var r;(r=i,s.minv.blockPosition-r.maxv.blockPosition<65e3&&s.maxv.blockPosition-r.minv.blockPosition<5e6)?s.maxv.compareTo(i.maxv)>0&&(i.maxv=s.maxv):(a.push(s),i=s)}}return a}function o(e,t){return{lineCount:function(e,t=0){let i=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24;return((e[t+4]|e[t+5]<<8|e[t+6]<<16|e[t+7]<<24)>>>0)*0x100000000+(i>>>0)}(e,t)}}function d(e,t){return e?e.compareTo(t)>0?t:e:t}class h{filehandle;renameRefSeq;constructor({filehandle:e,renameRefSeq:t=e=>e}){this.filehandle=e,this.renameRefSeq=t}}class l extends h{setupP;async lineCount(e,t){let i=await this.parse(t);return i.indices[e]?.stats?.lineCount||0}async _parse(e){let t;let i=await this.filehandle.readFile(),a=new DataView(i.buffer);if(0x1494142!==a.getUint32(0,!0))throw Error("Not a BAI file");let n=a.getInt32(4,!0),h=8,l=Array(n);for(let e=0;e<n;e++){let n;let f=a.getInt32(h,!0);h+=4;let c={};for(let e=0;e<f;e+=1){let e=a.getUint32(h,!0);if(h+=4,37450===e)h+=4,n=o(i,h+16),h+=32;else if(e>37450)throw Error("bai index contains too many bins, please use CSI");else{let n=a.getInt32(h,!0);h+=4;let o=Array(n);for(let a=0;a<n;a++){let n=r(i,h),l=r(i,h+=8);h+=8,t=d(t,n),o[a]=new s(n,l,e)}c[e]=o}}let x=a.getInt32(h,!0);h+=4;let u=Array(x);for(let e=0;e<x;e++){let a=r(i,h);h+=8,t=d(t,a),u[e]=a}l[e]={binIndex:c,linearIndex:u,stats:n}}return{bai:!0,firstDataLine:t,maxBlockSize:65536,indices:l,refCount:n}}async indexCov(e,t,i,a={}){let r=(await this.parse(a)).indices[e];if(!r)return[];let{linearIndex:s=[],stats:n}=r;if(0===s.length)return[];let o=void 0===i?(s.length-1)*16384:i-i%16384+16384,d=void 0===t?0:t-t%16384,h=void 0!==t?Array((o-d)/16384):Array(s.length-1),l=s[s.length-1].blockPosition;if(o>(s.length-1)*16384)throw Error("query outside of range of linear index");let f=s[d/16384].blockPosition;for(let e=d/16384,t=0;e<o/16384;e++,t++)h[t]={score:s[e+1].blockPosition-f,start:16384*e,end:16384*e+16384},f=s[e+1].blockPosition;return h.map(e=>({...e,score:e.score*(n?.lineCount||0)/l}))}async blocksForRange(e,t,i,a={}){var r,o;let d;t<0&&(t=0);let h=await this.parse(a);if(!h)return[];let l=h.indices[e];if(!l)return[];let f=[[0,0],[1+((r=t)>>26),1+((o=i-1)>>26)],[9+(r>>23),9+(o>>23)],[73+(r>>20),73+(o>>20)],[585+(r>>17),585+(o>>17)],[4681+(r>>14),4681+(o>>14)]],c=[];for(let[e,t]of f)for(let i=e;i<=t;i++)if(l.binIndex[i])for(let e of l.binIndex[i])c.push(new s(e.minv,e.maxv,i));let x=l.linearIndex.length,u=Math.min(t>>14,x-1),b=Math.min(i>>14,x-1);for(let e=u;e<=b;++e){let t=l.linearIndex[e];t&&(!d||0>t.compareTo(d))&&(d=t)}return n(c,d)}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async hasRefSeq(e,t={}){let i=await this.parse(t);return!!i.indices[e]?.binIndex}}var f=i(71327),c=i(29265),x=i(48559),u=i(28126),b=i(68134),g=i.n(b);function m(e,t){return Math.floor(e/2**t)}class w extends h{maxBinNumber=0;depth=0;minShift=0;setupP;async lineCount(e,t){let i=await this.parse(t);return i.indices[e]?.stats?.lineCount||0}async indexCov(){return[]}parseAuxData(e,t){let i=new DataView(e.buffer),a=i.getUint32(t,!0),r={0:"generic",1:"SAM",2:"VCF"}[15&a];if(!r)throw Error(`invalid Tabix preset format flags ${a}`);let s={ref:i.getInt32(t+4,!0),start:i.getInt32(t+8,!0),end:i.getInt32(t+12,!0)},n=i.getInt32(t+16,!0),o=n?String.fromCharCode(n):"",d=i.getInt32(t+20,!0),h=i.getInt32(t+24,!0);return{columnNumbers:s,coordinateType:65536&a?"zero-based-half-open":"1-based-closed",metaValue:n,metaChar:o,skipLines:d,format:r,formatFlags:a,...function(e,t=e=>e){let i=0,a=0,r=[],s={};for(let n=0;n<e.length;n+=1)if(!e[n]){if(a<n){let o="";for(let t=a;t<n;t++)o+=String.fromCharCode(e[t]);o=t(o),r[i]=o,s[o]=i}a=n+1,i+=1}return{refNameToId:s,refIdToName:r}}(e.subarray(t+28,t+28+h),this.renameRefSeq)}}async _parse(e){let t,i;let a=await this.filehandle.readFile(e),n=await (0,c.unzip)(a),h=new DataView(n.buffer),l=h.getUint32(0,!0);if(0x1495343===l)t=1;else if(0x2495343===l)t=2;else throw Error(`Not a CSI file ${l}`);this.minShift=h.getInt32(4,!0),this.depth=h.getInt32(8,!0),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;let f=h.getInt32(12,!0),x=f>=30?this.parseAuxData(n,16):void 0,u=h.getInt32(16+f,!0),b=16+f+4,g=Array(u);for(let e=0;e<u;e++){let t;let a=h.getInt32(b,!0);b+=4;let l={};for(let e=0;e<a;e++){let e=h.getUint32(b,!0);if(b+=4,e>this.maxBinNumber)t=o(n,b+28),b+=44;else{i=d(i,r(n,b)),b+=8;let t=h.getInt32(b,!0);b+=4;let a=Array(t);for(let o=0;o<t;o+=1){let t=r(n,b),h=r(n,b+=8);b+=8,i=d(i,t),a[o]=new s(t,h,e)}l[e]=a}}g[e]={binIndex:l,stats:t}}return{csiVersion:t,firstDataLine:i,indices:g,refCount:u,csi:!0,maxBlockSize:65536,...x}}async blocksForRange(e,t,i,r={}){t<0&&(t=0);let s=(await this.parse(r)).indices[e];if(!s)return[];let o=this.reg2bins(t,i);if(0===o.length)return[];let d=[];for(let[e,t]of o)for(let i=e;i<=t;i++)if(s.binIndex[i])for(let e of s.binIndex[i])d.push(e);return n(d,new a(0,0))}reg2bins(e,t){var i;(e-=1)<1&&(e=1),t>0x4000000000000&&(t=0x400000000),t-=1;let a=0,r=0,s=this.minShift+3*this.depth,n=[];for(;a<=this.depth;s-=3,r+=(i=3*a,1*2**i),a+=1){let i=r+m(e,s),a=r+m(t,s);if(a-i+n.length>this.maxBinNumber)throw Error(`query ${e}-${t} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);n.push([i,a])}return n}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async hasRefSeq(e,t={}){let i=await this.parse(t);return!!i.indices[e]?.binIndex}}let p={BAM_FPAIRED:1,BAM_FPROPER_PAIR:2,BAM_FUNMAP:4,BAM_FMUNMAP:8,BAM_FREVERSE:16,BAM_FMREVERSE:32,BAM_FREAD1:64,BAM_FREAD2:128,BAM_FSECONDARY:256,BAM_FQCFAIL:512,BAM_FDUP:1024,BAM_FSUPPLEMENTARY:2048},y="=ACMGRSVTWYHKDBN".split(""),_="MIDNSHP=X???????".split("");class A{fileOffset;bytes;#e;constructor(e){this.bytes=e.bytes,this.fileOffset=e.fileOffset,this.#e=new DataView(this.bytes.byteArray.buffer)}get byteArray(){return this.bytes.byteArray}get flags(){return(0xffff0000&this.#e.getInt32(this.bytes.start+16,!0))>>16}get ref_id(){return this.#e.getInt32(this.bytes.start+4,!0)}get start(){return this.#e.getInt32(this.bytes.start+8,!0)}get end(){return this.start+this.length_on_ref}get id(){return this.fileOffset}get mq(){let e=(65280&this.bin_mq_nl)>>8;return 255===e?void 0:e}get score(){return this.mq}get qual(){if(this.isSegmentUnmapped())return;let e=this.b0+this.read_name_length+4*this.num_cigar_ops+this.num_seq_bytes;return this.byteArray.subarray(e,e+this.seq_length)}get strand(){return this.isReverseComplemented()?-1:1}get b0(){return this.bytes.start+36}get name(){let e="";for(let t=0;t<this.read_name_length-1;t++)e+=String.fromCharCode(this.byteArray[this.b0+t]);return e}get tags(){let e=this.b0+this.read_name_length+4*this.num_cigar_ops+this.num_seq_bytes+this.seq_length,t=this.bytes.end,i={};for(;e<t;){let a=String.fromCharCode(this.byteArray[e],this.byteArray[e+1]),r=String.fromCharCode(this.byteArray[e+2]);if(e+=3,"A"===r)i[a]=String.fromCharCode(this.byteArray[e]),e+=1;else if("i"===r)i[a]=this.#e.getInt32(e,!0),e+=4;else if("I"===r)i[a]=this.#e.getUint32(e,!0),e+=4;else if("c"===r)i[a]=this.#e.getInt8(e),e+=1;else if("C"===r)i[a]=this.#e.getUint8(e),e+=1;else if("s"===r)i[a]=this.#e.getInt16(e,!0),e+=2;else if("S"===r)i[a]=this.#e.getUint16(e,!0),e+=2;else if("f"===r)i[a]=this.#e.getFloat32(e,!0),e+=4;else if("Z"===r||"H"===r){let r=[];for(;e<=t;){let t=this.byteArray[e++];if(0!==t)r.push(String.fromCharCode(t));else break}i[a]=r.join("")}else if("B"===r){let t=String.fromCharCode(this.byteArray[e++]),r=this.#e.getInt32(e,!0);if(e+=4,"i"===t){if("CG"===a){let t=[];for(let i=0;i<r;i++){let i=this.#e.getInt32(e,!0),a=i>>4,r=_[15&i];t.push(a+r),e+=4}i[a]=t.join("")}else{let t=[];for(let i=0;i<r;i++)t.push(this.#e.getInt32(e,!0)),e+=4;i[a]=t}}else if("I"===t){if("CG"===a){let t=[];for(let i=0;i<r;i++){let i=this.#e.getUint32(e,!0),a=i>>4,r=_[15&i];t.push(a+r),e+=4}i[a]=t.join("")}else{let t=[];for(let i=0;i<r;i++)t.push(this.#e.getUint32(e,!0)),e+=4;i[a]=t}}else if("s"===t){let t=[];for(let i=0;i<r;i++)t.push(this.#e.getInt16(e,!0)),e+=2;i[a]=t}else if("S"===t){let t=[];for(let i=0;i<r;i++)t.push(this.#e.getUint16(e,!0)),e+=2;i[a]=t}else if("c"===t){let t=[];for(let i=0;i<r;i++)t.push(this.#e.getInt8(e)),e+=1;i[a]=t}else if("C"===t){let t=[];for(let i=0;i<r;i++)t.push(this.#e.getUint8(e)),e+=1;i[a]=t}else if("f"===t){let t=[];for(let i=0;i<r;i++)t.push(this.#e.getFloat32(e,!0)),e+=4;i[a]=t}}else{console.error("Unknown BAM tag type",r);break}}return i}isPaired(){return!!(this.flags&p.BAM_FPAIRED)}isProperlyPaired(){return!!(this.flags&p.BAM_FPROPER_PAIR)}isSegmentUnmapped(){return!!(this.flags&p.BAM_FUNMAP)}isMateUnmapped(){return!!(this.flags&p.BAM_FMUNMAP)}isReverseComplemented(){return!!(this.flags&p.BAM_FREVERSE)}isMateReverseComplemented(){return!!(this.flags&p.BAM_FMREVERSE)}isRead1(){return!!(this.flags&p.BAM_FREAD1)}isRead2(){return!!(this.flags&p.BAM_FREAD2)}isSecondary(){return!!(this.flags&p.BAM_FSECONDARY)}isFailedQc(){return!!(this.flags&p.BAM_FQCFAIL)}isDuplicate(){return!!(this.flags&p.BAM_FDUP)}isSupplementary(){return!!(this.flags&p.BAM_FSUPPLEMENTARY)}get cigarAndLength(){if(this.isSegmentUnmapped())return{length_on_ref:0,CIGAR:""};let e=this.num_cigar_ops,t=this.b0+this.read_name_length,i=[],a=this.#e.getInt32(t,!0),r=a>>4,s=_[15&a];if("S"===s&&r===this.seq_length)return t+=4,r=(a=this.#e.getInt32(t,!0))>>4,"N"!==(s=_[15&a])&&console.warn("CG tag with no N tag"),{CIGAR:this.tags.CG,length_on_ref:r};{let n=0;for(let o=0;o<e;++o)r=(a=this.#e.getInt32(t,!0))>>4,s=_[15&a],i.push(r+s),"H"!==s&&"S"!==s&&"I"!==s&&(n+=r),t+=4;return{CIGAR:i.join(""),length_on_ref:n}}}get length_on_ref(){return this.cigarAndLength.length_on_ref}get CIGAR(){return this.cigarAndLength.CIGAR}get num_cigar_ops(){return 65535&this.flag_nc}get read_name_length(){return 255&this.bin_mq_nl}get num_seq_bytes(){return this.seq_length+1>>1}get seq(){let{byteArray:e}=this.bytes,t=this.b0+this.read_name_length+4*this.num_cigar_ops,i=this.num_seq_bytes,a=this.seq_length,r=[],s=0;for(let n=0;n<i;++n){let i=e[t+n];r.push(y[(240&i)>>4]),++s<a&&(r.push(y[15&i]),s++)}return r.join("")}get pair_orientation(){if(!this.isSegmentUnmapped()&&!this.isMateUnmapped()&&this.ref_id===this.next_refid){let e=this.isReverseComplemented()?"R":"F",t=this.isMateReverseComplemented()?"R":"F",i=" ",a=" ";this.isRead1()?(i="1",a="2"):this.isRead2()&&(i="2",a="1");let r=[];return this.template_length>0?(r[0]=e,r[1]=i,r[2]=t,r[3]=a):(r[2]=e,r[3]=i,r[0]=t,r[1]=a),r.join("")}}get bin_mq_nl(){return this.#e.getInt32(this.bytes.start+12,!0)}get flag_nc(){return this.#e.getInt32(this.bytes.start+16,!0)}get seq_length(){return this.#e.getInt32(this.bytes.start+20,!0)}get next_refid(){return this.#e.getInt32(this.bytes.start+24,!0)}get next_pos(){return this.#e.getInt32(this.bytes.start+28,!0)}get template_length(){return this.#e.getInt32(this.bytes.start+32,!0)}toJSON(){let e={};for(let t of Object.keys(this))t.startsWith("_")||"bytes"===t||(e[t]=this[t]);return e}}function I(e,t){let i=Object.getOwnPropertyDescriptor(e.prototype,t);if(!i)throw Error("OH NO, NO PROPERTY DESCRIPTOR");let a=i.get;if(!a)throw Error("OH NO, NOT A GETTER");Object.defineProperty(e.prototype,t,{get(){let e=a.call(this);return Object.defineProperty(this,t,{value:e}),e}})}function P(e){let t=e.split(/\r?\n/),i=[];for(let e of t){let[t,...a]=e.split(/\t/);t&&i.push({tag:t.slice(1),data:a.map(e=>{let t=e.indexOf(":");return{tag:e.slice(0,t),value:e.slice(t+1)}})})}return i}async function S(e){let t=[];for await(let i of e)t=t.concat(i);return t}I(A,"tags"),I(A,"cigarAndLength"),I(A,"seq"),I(A,"qual");class R{read(){throw Error("never called")}stat(){throw Error("never called")}readFile(){throw Error("never called")}close(){throw Error("never called")}}class v{renameRefSeq;bam;header;chrToIndex;indexToChr;yieldThreadTime;index;htsget=!1;headerP;featureCache=new u.A({cache:new(g())({maxSize:50}),fill:async(e,t)=>{let{chunk:i,opts:a}=e,{data:r,cpositions:s,dpositions:n}=await this._readChunk({chunk:i,opts:{...a,signal:t}});return this.readBamFeatures(r,s,n,i)}});constructor({bamFilehandle:e,bamPath:t,bamUrl:i,baiPath:a,baiFilehandle:r,baiUrl:s,csiPath:n,csiFilehandle:o,csiUrl:d,htsget:h,yieldThreadTime:f=100,renameRefSeqs:c=e=>e}){if(this.renameRefSeq=c,e)this.bam=e;else if(t)this.bam=new x.LocalFile(t);else if(i)this.bam=new x.RemoteFile(i);else if(h)this.htsget=!0,this.bam=new R;else throw Error("unable to initialize bam");if(o)this.index=new w({filehandle:o});else if(n)this.index=new w({filehandle:new x.LocalFile(n)});else if(d)this.index=new w({filehandle:new x.RemoteFile(d)});else if(r)this.index=new l({filehandle:r});else if(a)this.index=new l({filehandle:new x.LocalFile(a)});else if(s)this.index=new l({filehandle:new x.RemoteFile(s)});else if(t)this.index=new l({filehandle:new x.LocalFile(`${t}.bai`)});else if(i)this.index=new l({filehandle:new x.RemoteFile(`${i}.bai`)});else if(h)this.htsget=!0;else throw Error("unable to infer index format");this.yieldThreadTime=f}async getHeaderPre(e){let t;let i=function(e={}){return"aborted"in e?{signal:e}:e}(e);if(!this.index)return;let a=await this.index.parse(i),r=a.firstDataLine?a.firstDataLine.blockPosition+65535:void 0;t=r?await this.bam.read(r+65536,0):await this.bam.readFile(i);let s=await (0,c.unzip)(t),n=new DataView(s.buffer);if(0x14d4142!==n.getInt32(0,!0))throw Error("Not a BAM file");let o=n.getInt32(4,!0),d=new TextDecoder("utf8");this.header=d.decode(s.subarray(8,8+o));let{chrToIndex:h,indexToChr:l}=await this._readRefSeqs(o+8,65535,i);return this.chrToIndex=h,this.indexToChr=l,P(this.header)}getHeader(e){return this.headerP||(this.headerP=this.getHeaderPre(e).catch(e=>{throw this.headerP=void 0,e})),this.headerP}async getHeaderText(e={}){return await this.getHeader(e),this.header}async _readRefSeqs(e,t,i){if(e>t)return this._readRefSeqs(e,2*t,i);let a=await this.bam.read(t,0,i),r=await (0,c.unzip)(a),s=new DataView(r.buffer),n=s.getInt32(e,!0),o=e+4,d={},h=[],l=new TextDecoder("utf8");for(let a=0;a<n;a+=1){let n=s.getInt32(o,!0),f=this.renameRefSeq(l.decode(r.subarray(o+4,o+4+n-1))),c=s.getInt32(o+n+4,!0);if(d[f]=a,h.push({refName:f,length:c}),(o=o+8+n)>r.length)return console.warn(`BAM header is very big.  Re-fetching ${t} bytes.`),this._readRefSeqs(e,2*t,i)}return{chrToIndex:d,indexToChr:h}}async getRecordsForRange(e,t,i,a){return S(this.streamRecordsForRange(e,t,i,a))}async *streamRecordsForRange(e,t,i,a){await this.getHeader(a);let r=this.chrToIndex?.[e];if(void 0!==r&&this.index){let e=await this.index.blocksForRange(r,t-1,i,a);yield*this._fetchChunkFeatures(e,r,t,i,a)}else yield[]}async *_fetchChunkFeatures(e,t,i,a,r={}){let{viewAsPairs:s}=r,n=[],o=!1;for(let s of e){let e=await this.featureCache.get(s.toString(),{chunk:s,opts:r},r.signal),d=[];for(let r of e)if(r.ref_id===t){if(r.start>=a){o=!0;break}r.end>=i&&d.push(r)}if(n.push(d),yield d,o)break}(function(e){if(e&&e.aborted){if("undefined"==typeof DOMException){let e=Error("aborted");throw e.code="ERR_ABORTED",e}throw new DOMException("aborted","AbortError")}})(r.signal),s&&(yield this.fetchPairs(t,n,r))}async fetchPairs(e,t,i){let{pairAcrossChr:a,maxInsertSize:r=2e5}=i,s={},n={};t.map(e=>{let t={};for(let i of e){let e=i.name,a=i.id;t[e]||(t[e]=0),t[e]++,n[a]=1}for(let[e,i]of Object.entries(t))1===i&&(s[e]=!0)});let o=[];t.map(t=>{for(let n of t){let t=n.name,d=n.start,h=n.next_pos,l=n.next_refid;this.index&&s[t]&&(a||l===e&&Math.abs(d-h)<r)&&o.push(this.index.blocksForRange(l,h,h+1,i))}});let d=new Map;for(let e of(await Promise.all(o)).flat())d.has(e.toString())||d.set(e.toString(),e);return(await Promise.all([...d.values()].map(async e=>{let{data:t,cpositions:a,dpositions:r,chunk:o}=await this._readChunk({chunk:e,opts:i}),d=[];for(let e of(await this.readBamFeatures(t,a,r,o)))s[e.name]&&!n[e.id]&&d.push(e);return d}))).flat()}async _readRegion(e,t,i={}){return this.bam.read(t,e,i)}async _readChunk({chunk:e,opts:t}){let i=await this._readRegion(e.minv.blockPosition,e.fetchedSize(),t),{buffer:a,cpositions:r,dpositions:s}=await (0,c.unzipChunkSlice)(i,e);return{data:a,cpositions:r,dpositions:s,chunk:e}}async readBamFeatures(e,t,i,a){let r=0,s=[],n=0,o=+Date.now(),d=new DataView(e.buffer);for(;r+4<e.length;){let h=d.getInt32(r,!0),l=r+4+h-1;if(i){for(;r+a.minv.dataPosition>=i[n++];);n--}if(l<e.length){let d=new A({bytes:{byteArray:e,start:r,end:l},fileOffset:t.length>0?256*t[n]+(r-i[n])+a.minv.dataPosition+1:(0,f.A)(e.subarray(r,l))>>>0});s.push(d),this.yieldThreadTime&&+Date.now()-o>this.yieldThreadTime&&(await new Promise(e=>setTimeout(e,1)),o=+Date.now())}r=l+1}return s}async hasRefSeq(e){let t=this.chrToIndex?.[e];return void 0!==t&&this.index?.hasRefSeq(t)}async lineCount(e){let t=this.chrToIndex?.[e];return void 0!==t&&this.index?this.index.lineCount(t):0}async indexCov(e,t,i){if(!this.index)return[];await this.index.parse();let a=this.chrToIndex?.[e];return void 0===a?[]:this.index.indexCov(a,t,i)}async blocksForRange(e,t,i,a){if(!this.index)return[];await this.index.parse();let r=this.chrToIndex?.[e];return void 0===r?[]:this.index.blocksForRange(r,t,i,a)}}async function C(e,t){let i=await Promise.all(e.map(async e=>{let{url:i,headers:a}=e;if(i.startsWith("data:")){let e=await fetch(i);if(!e.ok)throw Error("failed to decode base64");return new Uint8Array(await e.arrayBuffer())}{let{referer:e,...r}=a,s=await fetch(i,{...t,headers:{...t?.headers,...r}});if(!s.ok)throw Error(`HTTP ${s.status} fetching ${i}: ${await s.text()}`);return new Uint8Array(await s.arrayBuffer())}}));return function(e){let t=new Uint8Array(function(e){let t=0;for(let i of e)t+=i.length;return t}(e)),i=0;for(let a of e)t.set(a,i),i+=a.length;return t}(await Promise.all(i.map(e=>(0,c.unzip)(e))))}class F extends v{baseUrl;trackId;constructor(e){super({htsget:!0}),this.baseUrl=e.baseUrl,this.trackId=e.trackId}async *streamRecordsForRange(e,t,i,a){let r=`${this.baseUrl}/${this.trackId}`,s=`${r}?referenceName=${e}&start=${t}&end=${i}&format=BAM`,n=this.chrToIndex?.[e];if(void 0===n)yield[];else{let r=await fetch(s,{...a});if(!r.ok)throw Error(`HTTP ${r.status} fetching ${s}: ${await r.text()}`);let o=await r.json(),d=await C(o.htsget.urls.slice(1),a);yield*this._fetchChunkFeatures([{buffer:d,_fetchedSize:void 0,bin:0,compareTo:()=>0,toUniqueString:()=>`${e}_${t}_${i}`,fetchedSize:()=>0,minv:{dataPosition:0,blockPosition:0,compareTo:()=>0},maxv:{dataPosition:Number.MAX_SAFE_INTEGER,blockPosition:0,compareTo:()=>0},toString:()=>`${e}_${t}_${i}`}],n,t,i,a)}}async _readChunk({chunk:e}){if(!e.buffer)throw Error("expected chunk.buffer in htsget");return{data:e.buffer,cpositions:[],dpositions:[],chunk:e}}async getHeader(e={}){let t=`${this.baseUrl}/${this.trackId}?referenceName=na&class=header`,i=await fetch(t,e);if(!i.ok)throw Error(`HTTP ${i.status} fetching ${t}: ${await i.text()}`);let a=await i.json(),r=await C(a.htsget.urls,e),s=new DataView(r.buffer);if(0x14d4142!==s.getInt32(0,!0))throw Error("Not a BAM file");let n=s.getInt32(4,!0),o=P(new TextDecoder("utf8").decode(r.subarray(8,8+n))),d=[],h={};for(let[e,t]of o.filter(e=>"SQ"===e.tag).entries()){let i="",a=0;for(let e of t.data)"SN"===e.tag?i=e.value:"LN"===e.tag&&(a=+e.value);h[i]=e,d[e]={refName:i,length:a}}return this.chrToIndex=h,this.indexToChr=d,o}}},50764:(e,t,i)=>{i.r(t),i.d(t,{default:()=>b});var a=i(33952),r=i(92766),s=i(54262),n=i(61078),o=i(31177),d=i(72471),h=i(28251),l=i(90287),f=i(18998),c=i(46042),x=i(50324);class u{constructor(e,t,i){this.record=e,this.adapter=t,this.ref=i}id(){return`${this.adapter.id}-${this.record.id}`}get mismatches(){return(0,c.DQ)(this.record.CIGAR,this.record.tags.MD,this.record.seq,this.ref,this.record.qual)}get qual(){var e;return null===(e=this.record.qual)||void 0===e?void 0:e.join(" ")}get(e){return"mismatches"===e?this.mismatches:"qual"===e?this.qual:this.fields[e]}parent(){}children(){}get fields(){let e=this.record,t=this.adapter,i=e.isPaired();return{start:e.start,name:e.name,end:e.end,score:e.score,strand:e.strand,template_length:e.template_length,flags:e.flags,tags:e.tags,refName:t.refIdToName(e.ref_id),CIGAR:e.CIGAR,seq:e.seq,type:"match",pair_orientation:e.pair_orientation,next_ref:i?t.refIdToName(e.next_refid):void 0,next_pos:i?e.next_pos:void 0,next_segment_position:i?`${t.refIdToName(e.next_refid)}:${e.next_pos+1}`:void 0,uniqueId:this.id()}}toJSON(){return{...this.fields,qual:this.qual}}}(0,x.Kt)(u,"fields"),(0,x.Kt)(u,"mismatches");class b extends r.BaseFeatureDataAdapter{constructor(){super(...arguments),this.ultraLongFeatureCache=new n.default({maxSize:500})}async configurePre(){let e=this.getConf("bamLocation"),t=this.getConf(["index","location"]),i=this.getConf(["index","indexType"]),r=this.pluginManager,s="CSI"===i,n=new a.j9({bamFilehandle:(0,o.openLocation)(e,r),csiFilehandle:s?(0,o.openLocation)(t,r):void 0,baiFilehandle:s?void 0:(0,o.openLocation)(t,r),yieldThreadTime:Number.POSITIVE_INFINITY}),d=this.getConf("sequenceAdapter");if(d&&this.getSubAdapter){let{dataAdapter:e}=await this.getSubAdapter(d);return{bam:n,sequenceAdapter:e}}return{bam:n}}async configure(){return this.configureP||(this.configureP=this.configurePre().catch(e=>{throw this.configureP=void 0,e})),this.configureP}async getHeader(e){let{bam:t}=await this.configure();return t.getHeaderText()}async setupPre(e){let{statusCallback:t=()=>{}}=e||{},{bam:i}=await this.configure();return this.samHeader=await (0,s.updateStatus)("Downloading index",t,async()=>{let e=await i.getHeader(),t=[],a={};return null==e||e.filter(e=>"SQ"===e.tag).forEach((e,i)=>{let r=e.data.find(e=>"SN"===e.tag);if(r){let e=r.value;a[e]=i,t[i]=e}}),{idToName:t,nameToId:a}}),this.samHeader}async setup(e){return this.setupP||(this.setupP=this.setupPre(e).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async getRefNames(e){let{idToName:t}=await this.setup(e);return t}async seqFetch(e,t,i){let{sequenceAdapter:a}=await this.configure();if(!a||!e)return;let r=a.getFeatures({refName:e,start:t,end:i,assemblyName:""}),s=await (0,l._)(r.pipe((0,f.$)())),n="";if(s.sort((e,t)=>e.get("start")-t.get("start")).forEach(e=>{let a=e.get("start"),r=e.get("end"),s=Math.max(t-a,0),o=Math.min(i-a,r-a)-s,d=e.get("seq")||e.get("residues");n+=d.slice(s,s+o)}),n.length!==i-t)throw Error(`sequence fetch failed: fetching ${e}:${(t-1).toLocaleString()}-${i.toLocaleString()} returned ${n.length.toLocaleString()} bases, but should have returned ${(i-t).toLocaleString()}`);return n}getFeatures(e,t){let{refName:i,start:a,end:r,originalRefName:n}=e,{stopToken:o,filterBy:l,statusCallback:f=()=>{}}=t||{};return(0,d.ObservableCreate)(async e=>{let{bam:d}=await this.configure();await this.setup(t),(0,h.checkStopToken)(o);let c=await (0,s.updateStatus)("Downloading alignments",f,()=>d.getRecordsForRange(i,a,r));(0,h.checkStopToken)(o),await (0,s.updateStatus)("Processing alignments",f,async()=>{let{flagInclude:t=0,flagExclude:a=0,tagFilter:r,readName:s}=l||{};for(let o of c){let d;if(o.tags.MD||(d=await this.seqFetch(n||i,o.start,o.end)),(0,x.lE)(o.flags,t,a)||r&&(0,x.Kl)(o.tags[r.tag],r.value)||s&&o.name!==s)continue;let h=this.ultraLongFeatureCache.get(`${o.id}`);if(h)e.next(h);else{let t=new u(o,this,d);this.ultraLongFeatureCache.set(`${o.id}`,t),e.next(t)}}e.complete()})})}async getMultiRegionFeatureDensityStats(e,t){let{bam:i}=await this.configure();return i.index?{bytes:await (0,s.bytesForRegions)(e,i),fetchSizeLimit:this.getConf("fetchSizeLimit")}:super.getMultiRegionFeatureDensityStats(e,t)}freeResources(){}refIdToName(e){var t;return null===(t=this.samHeader)||void 0===t?void 0:t.idToName[e]}}},71327:(e,t,i)=>{i.d(t,{A:()=>r});let a=[0,0x77073096,0xee0e612c,0x990951ba,0x76dc419,0x706af48f,0xe963a535,0x9e6495a3,0xedb8832,0x79dcb8a4,0xe0d5e91e,0x97d2d988,0x9b64c2b,0x7eb17cbd,0xe7b82d07,0x90bf1d91,0x1db71064,0x6ab020f2,0xf3b97148,0x84be41de,0x1adad47d,0x6ddde4eb,0xf4d4b551,0x83d385c7,0x136c9856,0x646ba8c0,0xfd62f97a,0x8a65c9ec,0x14015c4f,0x63066cd9,0xfa0f3d63,0x8d080df5,0x3b6e20c8,0x4c69105e,0xd56041e4,0xa2677172,0x3c03e4d1,0x4b04d447,0xd20d85fd,0xa50ab56b,0x35b5a8fa,0x42b2986c,0xdbbbc9d6,0xacbcf940,0x32d86ce3,0x45df5c75,0xdcd60dcf,0xabd13d59,0x26d930ac,0x51de003a,0xc8d75180,0xbfd06116,0x21b4f4b5,0x56b3c423,0xcfba9599,0xb8bda50f,0x2802b89e,0x5f058808,0xc60cd9b2,0xb10be924,0x2f6f7c87,0x58684c11,0xc1611dab,0xb6662d3d,0x76dc4190,0x1db7106,0x98d220bc,0xefd5102a,0x71b18589,0x6b6b51f,0x9fbfe4a5,0xe8b8d433,0x7807c9a2,0xf00f934,0x9609a88e,0xe10e9818,0x7f6a0dbb,0x86d3d2d,0x91646c97,0xe6635c01,0x6b6b51f4,0x1c6c6162,0x856530d8,0xf262004e,0x6c0695ed,0x1b01a57b,0x8208f4c1,0xf50fc457,0x65b0d9c6,0x12b7e950,0x8bbeb8ea,0xfcb9887c,0x62dd1ddf,0x15da2d49,0x8cd37cf3,0xfbd44c65,0x4db26158,0x3ab551ce,0xa3bc0074,0xd4bb30e2,0x4adfa541,0x3dd895d7,0xa4d1c46d,0xd3d6f4fb,0x4369e96a,0x346ed9fc,0xad678846,0xda60b8d0,0x44042d73,0x33031de5,0xaa0a4c5f,0xdd0d7cc9,0x5005713c,0x270241aa,0xbe0b1010,0xc90c2086,0x5768b525,0x206f85b3,0xb966d409,0xce61e49f,0x5edef90e,0x29d9c998,0xb0d09822,0xc7d7a8b4,0x59b33d17,0x2eb40d81,0xb7bd5c3b,0xc0ba6cad,0xedb88320,0x9abfb3b6,0x3b6e20c,0x74b1d29a,0xead54739,0x9dd277af,0x4db2615,0x73dc1683,0xe3630b12,0x94643b84,0xd6d6a3e,0x7a6a5aa8,0xe40ecf0b,0x9309ff9d,0xa00ae27,0x7d079eb1,0xf00f9344,0x8708a3d2,0x1e01f268,0x6906c2fe,0xf762575d,0x806567cb,0x196c3671,0x6e6b06e7,0xfed41b76,0x89d32be0,0x10da7a5a,0x67dd4acc,0xf9b9df6f,0x8ebeeff9,0x17b7be43,0x60b08ed5,0xd6d6a3e8,0xa1d1937e,0x38d8c2c4,0x4fdff252,0xd1bb67f1,0xa6bc5767,0x3fb506dd,0x48b2364b,0xd80d2bda,0xaf0a1b4c,0x36034af6,0x41047a60,0xdf60efc3,0xa867df55,0x316e8eef,0x4669be79,0xcb61b38c,0xbc66831a,0x256fd2a0,0x5268e236,0xcc0c7795,0xbb0b4703,0x220216b9,0x5505262f,0xc5ba3bbe,0xb2bd0b28,0x2bb45a92,0x5cb36a04,0xc2d7ffa7,0xb5d0cf31,0x2cd99e8b,0x5bdeae1d,0x9b64c2b0,0xec63f226,0x756aa39c,0x26d930a,0x9c0906a9,0xeb0e363f,0x72076785,0x5005713,0x95bf4a82,0xe2b87a14,0x7bb12bae,0xcb61b38,0x92d28e9b,0xe5d5be0d,0x7cdcefb7,0xbdbdf21,0x86d3d2d4,0xf1d4e242,0x68ddb3f8,0x1fda836e,0x81be16cd,0xf6b9265b,0x6fb077e1,0x18b74777,0x88085ae6,0xff0f6a70,0x66063bca,0x11010b5c,0x8f659eff,0xf862ae69,0x616bffd3,0x166ccf45,0xa00ae278,0xd70dd2ee,0x4e048354,0x3903b3c2,0xa7672661,0xd06016f7,0x4969474d,0x3e6e77db,0xaed16a4a,0xd9d65adc,0x40df0b66,936918e3,0xa9bcae53,0xdebb9ec5,0x47b2cf7f,0x30b5ffe9,0xbdbdf21c,0xcabac28a,0x53b39330,0x24b4a3a6,0xbad03605,0xcdd70693,0x54de5729,0x23d967bf,0xb3667a2e,0xc4614ab8,0x5d681b02,0x2a6f2b94,0xb40bbe37,0xc30c8ea1,0x5a05df1b,0x2d02ef8d];"undefined"!=typeof Int32Array&&(a=new Int32Array(a));let r=(e,t)=>{let i=0===t?0:-1^~~t;for(let t=0;t<e.length;t++)i=a[(i^e[t])&255]^i>>>8;return -1^i}}}]);
//# sourceMappingURL=764.aca90cb4c0883b11.js.map