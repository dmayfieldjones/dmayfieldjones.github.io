"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2468],{29468:(e,t,r)=>{r.d(t,{r:()=>o});var n=r(86847),s=r(43057),i=r(25653),a=r(9273);function o(e,t){let r=e.get("strand"),o=e.get("seq"),l=(0,a.c$)(e,"MM","Mm")||"",d=t||(0,n.eL)(e.get("CIGAR"));if(o){let t=(0,i.Z1)(l,o,r),n=(0,i.Yj)(e),a=[],f=0;for(let{type:e,positions:i}of t){for(let{ref:t,idx:o}of(0,s.h)(d,i)){let s=(null==n?void 0:n[f+(-1===r?i.length-1-o:o)])||0;if(a[t]){let r=a[t];a[t]={allProbs:[...r.allProbs,s],prob:Math.max(r.prob,s),type:r.prob>s?r.type:e}}else a[t]={type:e,prob:s,allProbs:[s]}}f+=i.length}return a}}},72468:(e,t,r)=>{r.r(t),r.d(t,{default:()=>v});var n=r(29269),s=r(31232),i=r(91603),a=r(41431),o=r(96885),l=r(9273),d=r(15715),f=r(64294);function p(e){return"softclip"===e||"hardclip"===e||"insertion"===e}function c(e,t,r,n){let s=e[r][n];void 0===s&&(s=e[r][n]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),s.entryDepth++,s[t]++}function u(e,t,r,n,s){let i=e[r][n];void 0===i&&(i=e[r][n]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),i.entryDepth++,i.probabilities.push(s),i[t]++}var h=r(29468),g=r(86847),m=r(25653);async function b({fetchSequence:e,features:t,region:r,opts:n}){let{stopToken:s,colorBy:i}=n,a={},o=[],l=Math.max(0,r.start-1),b=r.start-l,v=performance.now();for(let n of t){if(performance.now()-v>400&&((0,f.checkStopToken)(s),v=performance.now()),!function({feature:e,bins:t,region:r}){let n=e.get("start"),s=e.get("end"),i=e.get("strand"),a=r.end-r.start;for(let e=n;e<s+1;e++){let n=e-r.start;n>=0&&n<a&&(void 0===t[n]&&(t[n]={depth:0,readsCounted:0,ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},snps:{},mods:{},nonmods:{},delskips:{},noncov:{}}),e!==s&&(t[n].depth++,t[n].readsCounted++,t[n].ref.entryDepth++,t[n].ref[i]++))}}({feature:n,bins:o,region:r}),(null==i?void 0:i.type)==="modifications"){let t=await e({...r,start:l,end:r.end+1})||"";!function({feature:e,colorBy:t,region:r,bins:n,regionSequence:s}){var i,a;let o=e.get("start"),l=e.get("strand"),f=e.get("end"),p=null==(i=null==t?void 0:t.modifications)?void 0:i.twoColor,c=null==(a=null==t?void 0:t.modifications)?void 0:a.isolatedModification,g=(0,h.r)(e);if(g){let e=0;for(let{type:t,prob:i,allProbs:a}of g){if(c&&t!==c)return;let h=e+o-r.start;if(h>=0&&h<n.length&&e+o<f){void 0===n[h]&&(n[h]={depth:0,readsCounted:0,snps:{},ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},mods:{},nonmods:{},delskips:{},noncov:{}});let e=1-(0,d.sum)(a),r=n[h];r.refbase=s[h],p&&e>(0,d.max)(a)?u(r,l,"nonmods",`nonmod_${t}`,e):u(r,l,"mods",`mod_${t}`,i)}e++}}}({feature:n,colorBy:i,bins:o,region:r,regionSequence:t.slice(b)})}else if((null==i?void 0:i.type)==="methylation"){let t=await e({...r,start:l,end:r.end+1})||"";!function({feature:e,region:t,bins:r,regionSequence:n}){var s;let i=e.get("start"),a=e.get("end"),o=e.get("strand"),l=e.get("seq"),f=null!=(s=e.get("mismatches"))?s:[],p=n.toLowerCase();if(l){let n=(0,g.eL)(e.get("CIGAR")),{methBins:s,methProbs:l}=(0,m.Ps)(e,n),c=f.filter(e=>"deletion"===e.type);for(let e=0;e<a-i;e++){let n=e+i,a=p[n-t.start+1],f=p[n-t.start+2];if("c"===a&&"g"===f){let a=r[n-t.start],f=r[n-t.start+1],p=s[e],h=s[e+1],g=l[e],m=l[e+1];p&&(void 0===g||g>.5)||h&&(void 0===m||m>.5)?(a&&(u(a,o,"mods","cpg_meth",g||0),a.ref.entryDepth--,a.ref[o]--),f&&(u(f,o,"mods","cpg_meth",m||0),f.ref.entryDepth--,f.ref[o]--)):(a&&!c.some(e=>(0,d.doesIntersect2)(n,n+1,e.start+i,e.start+i+e.length))&&(u(a,o,"nonmods","cpg_unmeth",1-(g||0)),a.ref.entryDepth--,a.ref[o]--),f&&!c.some(e=>(0,d.doesIntersect2)(n+1,n+2,e.start+i,e.start+i+e.length))&&(u(f,o,"nonmods","cpg_unmeth",1-(m||0)),f.ref.entryDepth--,f.ref[o]--))}}}}({feature:n,bins:o,region:r,regionSequence:t})}!function({feature:e,region:t,bins:r,skipmap:n}){var s;let i=e.get("start"),a=e.get("strand");for(let o of null!=(s=e.get("mismatches"))?s:[]){let s=i+o.start,l=p(o.type)?1:o.length,d=s+l;for(let e=s;e<s+l;e++){let n=e-t.start;if(n>=0&&n<r.length){let e=r[n],{base:t,altbase:s,type:i}=o,l=p(i);"deletion"===i||"skip"===i?(c(e,a,"delskips",i),e.depth--):l?c(e,a,"noncov",i):(c(e,a,"snps",t),e.ref.entryDepth--,e.ref[a]--,e.refbase=s)}}if("skip"===o.type){let t=e.get("tags"),r=(null==t?void 0:t.XS)||(null==t?void 0:t.TS),i=null==t?void 0:t.ts,o="+"===r?1:"-"===r?-1:("+"===i?1:"-"===r?-1:0)*a,l=`${s}_${d}_${o}`;void 0===n[l]&&(n[l]={feature:e,start:s,end:d,strand:a,effectiveStrand:o,score:0}),n[l].score++}}}({feature:n,skipmap:a,bins:o,region:r})}for(let e of o)e&&(e.mods=Object.fromEntries(Object.entries(e.mods).map(([e,t])=>[e,{...t,avgProbability:t.probabilities.length?(0,d.sum)(t.probabilities)/t.probabilities.length:void 0}])),e.nonmods=Object.fromEntries(Object.entries(e.nonmods).map(([e,t])=>[e,{...t,avgProbability:t.probabilities.length?(0,d.sum)(t.probabilities)/t.probabilities.length:void 0}])));return{bins:o,skipmap:a}}class v extends n.BaseFeatureDataAdapter{async configure(){var e,t;let r=this.getConf("subadapter"),n=r.sequenceAdapter,s=await (null==(e=this.getSubAdapter)?void 0:e.call(this,r)),i=n?await (null==(t=this.getSubAdapter)?void 0:t.call(this,n)):void 0;if(!s)throw Error("Failed to get subadapter");return{subadapter:s.dataAdapter,sequenceAdapter:null==i?void 0:i.dataAdapter}}async fetchSequence(e){let{sequenceAdapter:t}=await this.configure();if(t)return(0,l.Iw)(e,t)}getFeatures(e,t={}){return(0,s.ObservableCreate)(async r=>{let{subadapter:n}=await this.configure(),s=await (0,a._)(n.getFeatures(e,t).pipe((0,o.$)())),{bins:l,skipmap:d}=await b({features:s,region:e,opts:t,fetchSequence:e=>this.fetchSequence(e)}),f=0;for(let t of l){if(t){let n=e.start+f;r.next(new i.default({id:`${this.id}-${n}`,data:{score:t.depth,snpinfo:t,start:n,end:n+1,refName:e.refName}}))}f++}for(let[e,t]of Object.entries(d))r.next(new i.default({id:e,data:{type:"skip",start:t.start,end:t.end,strand:t.strand,score:t.score,effectiveStrand:t.effectiveStrand}}));r.complete()},t.stopToken)}async getMultiRegionFeatureDensityStats(e,t){let{subadapter:r}=await this.configure();return r.getMultiRegionFeatureDensityStats(e,t)}async getRefNames(e={}){let{subadapter:t}=await this.configure();return t.getRefNames(e)}freeResources(){}}}}]);
//# sourceMappingURL=2468.553779bcea34a097.js.map