"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2468],{29468:(e,t,r)=>{r.d(t,{r:()=>a});var n=r(86847),i=r(43057),o=r(25653),s=r(9273);function a(e,t){let r=e.get("strand"),a=e.get("seq"),l=(0,s.c$)(e,"MM","Mm")||"",d=t||(0,n.eL)(e.get("CIGAR"));if(a){let t=(0,o.Z1)(l,a,r),n=(0,o.Yj)(e),s=[],f=0;for(let{type:e,positions:o}of t){for(let{ref:t,idx:a}of(0,i.h)(d,o)){let i=(null==n?void 0:n[f+(-1===r?o.length-1-a:a)])||0;if(s[t]){let r=s[t];s[t]={allProbs:[...r.allProbs,i],prob:Math.max(r.prob,i),type:r.prob>i?r.type:e}}else s[t]={type:e,prob:i,allProbs:[i]}}f+=o.length}return s}}},72468:(e,t,r)=>{r.r(t),r.d(t,{default:()=>v});var n=r(29269),i=r(31232),o=r(91603),s=r(41431),a=r(96885),l=r(9273),d=r(15715),f=r(64294);function p(e){return"softclip"===e||"hardclip"===e||"insertion"===e}function c(e,t,r,n){let i=e[r][n];void 0===i&&(i=e[r][n]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),i.entryDepth++,i[t]++}function u(e,t,r,n,i){let o=e[r][n];void 0===o&&(o=e[r][n]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),o.entryDepth++,o.probabilities.push(i),o[t]++}var h=r(29468),g=r(86847),m=r(25653);async function b({fetchSequence:e,features:t,region:r,opts:n}){let{stopToken:i,colorBy:o}=n,s={},a=[],l=Math.max(0,r.start-1),b=r.start-l,v=performance.now();for(let n of t){if(performance.now()-v>400&&((0,f.checkStopToken)(i),v=performance.now()),!function({feature:e,bins:t,region:r}){let n=e.get("start"),i=e.get("end"),o=e.get("strand"),s=r.end-r.start;for(let e=n;e<i+1;e++){let n=e-r.start;n>=0&&n<s&&(void 0===t[n]&&(t[n]={depth:0,readsCounted:0,ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},snps:{},mods:{},nonmods:{},delskips:{},noncov:{}}),e!==i&&(t[n].depth++,t[n].readsCounted++,t[n].ref.entryDepth++,t[n].ref[o]++))}}({feature:n,bins:a,region:r}),(null==o?void 0:o.type)==="modifications"){let t=await e({...r,start:l,end:r.end+1})||"";!function({feature:e,colorBy:t,region:r,bins:n,regionSequence:i}){var o,s;let a=e.get("start"),l=e.get("strand"),f=e.get("end"),p=null===(o=null==t?void 0:t.modifications)||void 0===o?void 0:o.twoColor,c=null===(s=null==t?void 0:t.modifications)||void 0===s?void 0:s.isolatedModification,g=(0,h.r)(e);if(g){let e=0;for(let{type:t,prob:o,allProbs:s}of g){if(c&&t!==c)return;let h=e+a-r.start;if(h>=0&&h<n.length&&e+a<f){void 0===n[h]&&(n[h]={depth:0,readsCounted:0,snps:{},ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},mods:{},nonmods:{},delskips:{},noncov:{}});let e=1-(0,d.sum)(s),r=n[h];r.refbase=i[h],p&&e>(0,d.max)(s)?u(r,l,"nonmods",`nonmod_${t}`,e):u(r,l,"mods",`mod_${t}`,o)}e++}}}({feature:n,colorBy:o,bins:a,region:r,regionSequence:t.slice(b)})}else if((null==o?void 0:o.type)==="methylation"){let t=await e({...r,start:l,end:r.end+1})||"";!function({feature:e,region:t,bins:r,regionSequence:n}){var i;let o=e.get("start"),s=e.get("end"),a=e.get("strand"),l=e.get("seq"),f=null!==(i=e.get("mismatches"))&&void 0!==i?i:[],p=n.toLowerCase();if(l){let n=(0,g.eL)(e.get("CIGAR")),{methBins:i,methProbs:l}=(0,m.Ps)(e,n),c=f.filter(e=>"deletion"===e.type);for(let e=0;e<s-o;e++){let n=e+o,s=p[n-t.start+1],f=p[n-t.start+2];if("c"===s&&"g"===f){let s=r[n-t.start],f=r[n-t.start+1],p=i[e],h=i[e+1],g=l[e],m=l[e+1];p&&(void 0===g||g>.5)||h&&(void 0===m||m>.5)?(s&&(u(s,a,"mods","cpg_meth",g||0),s.ref.entryDepth--,s.ref[a]--),f&&(u(f,a,"mods","cpg_meth",m||0),f.ref.entryDepth--,f.ref[a]--)):(s&&!c.some(e=>(0,d.doesIntersect2)(n,n+1,e.start+o,e.start+o+e.length))&&(u(s,a,"nonmods","cpg_unmeth",1-(g||0)),s.ref.entryDepth--,s.ref[a]--),f&&!c.some(e=>(0,d.doesIntersect2)(n+1,n+2,e.start+o,e.start+o+e.length))&&(u(f,a,"nonmods","cpg_unmeth",1-(m||0)),f.ref.entryDepth--,f.ref[a]--))}}}}({feature:n,bins:a,region:r,regionSequence:t})}!function({feature:e,region:t,bins:r,skipmap:n}){var i;let o=e.get("start"),s=e.get("strand");for(let a of null!==(i=e.get("mismatches"))&&void 0!==i?i:[]){let i=o+a.start,l=p(a.type)?1:a.length,d=i+l;for(let e=i;e<i+l;e++){let n=e-t.start;if(n>=0&&n<r.length){let e=r[n],{base:t,altbase:i,type:o}=a,l=p(o);"deletion"===o||"skip"===o?(c(e,s,"delskips",o),e.depth--):l?c(e,s,"noncov",o):(c(e,s,"snps",t),e.ref.entryDepth--,e.ref[s]--,e.refbase=i)}}if("skip"===a.type){let t=e.get("tags"),r=(null==t?void 0:t.XS)||(null==t?void 0:t.TS),o=null==t?void 0:t.ts,a="+"===r?1:"-"===r?-1:("+"===o?1:"-"===r?-1:0)*s,l=`${i}_${d}_${a}`;void 0===n[l]&&(n[l]={feature:e,start:i,end:d,strand:s,effectiveStrand:a,score:0}),n[l].score++}}}({feature:n,skipmap:s,bins:a,region:r})}for(let e of a)e&&(e.mods=Object.fromEntries(Object.entries(e.mods).map(([e,t])=>[e,{...t,avgProbability:t.probabilities.length?(0,d.sum)(t.probabilities)/t.probabilities.length:void 0}])),e.nonmods=Object.fromEntries(Object.entries(e.nonmods).map(([e,t])=>[e,{...t,avgProbability:t.probabilities.length?(0,d.sum)(t.probabilities)/t.probabilities.length:void 0}])));return{bins:a,skipmap:s}}class v extends n.BaseFeatureDataAdapter{async configure(){var e,t;let r=this.getConf("subadapter"),n=r.sequenceAdapter,i=await (null===(e=this.getSubAdapter)||void 0===e?void 0:e.call(this,r)),o=n?await (null===(t=this.getSubAdapter)||void 0===t?void 0:t.call(this,n)):void 0;if(!i)throw Error("Failed to get subadapter");return{subadapter:i.dataAdapter,sequenceAdapter:null==o?void 0:o.dataAdapter}}async fetchSequence(e){let{sequenceAdapter:t}=await this.configure();if(t)return(0,l.Iw)(e,t)}getFeatures(e,t={}){return(0,i.ObservableCreate)(async r=>{let{subadapter:n}=await this.configure(),i=await (0,s._)(n.getFeatures(e,t).pipe((0,a.$)())),{bins:l,skipmap:d}=await b({features:i,region:e,opts:t,fetchSequence:e=>this.fetchSequence(e)}),f=0;for(let t of l){if(t){let n=e.start+f;r.next(new o.default({id:`${this.id}-${n}`,data:{score:t.depth,snpinfo:t,start:n,end:n+1,refName:e.refName}}))}f++}for(let[e,t]of Object.entries(d))r.next(new o.default({id:e,data:{type:"skip",start:t.start,end:t.end,strand:t.strand,score:t.score,effectiveStrand:t.effectiveStrand}}));r.complete()},t.stopToken)}async getMultiRegionFeatureDensityStats(e,t){let{subadapter:r}=await this.configure();return r.getMultiRegionFeatureDensityStats(e,t)}async getRefNames(e={}){let{subadapter:t}=await this.configure();return t.getRefNames(e)}freeResources(){}}}}]);
//# sourceMappingURL=2468.9967d10a54a58c0c.js.map