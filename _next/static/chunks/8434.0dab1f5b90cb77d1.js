"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8434],{98434:(e,t,i)=>{i.d(t,{wD:()=>v});var n=i(3273),r=i(99985),a=i.n(r),s=i(98135),l=i(71654);class o extends Error{}function h(e){if(e&&e.aborted)if("undefined"!=typeof DOMException)throw new DOMException("aborted","AbortError");else{let e=new o("aborted");throw e.code="ERR_ABORTED",e}}function f(e,t){let i=[],n=null;return 0===e.length?e:(e.sort(function(e,t){let i=e.minv.blockPosition-t.minv.blockPosition;return 0!==i?i:e.minv.dataPosition-t.minv.dataPosition}),e.forEach(e=>{if(!t||e.maxv.compareTo(t)>0)if(null===n)i.push(e),n=e;else{var r;(r=n,e.minv.blockPosition-r.maxv.blockPosition<65e3&&e.maxv.blockPosition-r.minv.blockPosition<5e6)?e.maxv.compareTo(n.maxv)>0&&(n.maxv=e.maxv):(i.push(e),n=e)}}),i)}class d{constructor(e,t){this.blockPosition=e,this.dataPosition=t}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(e){return this.blockPosition-e.blockPosition||this.dataPosition-e.dataPosition}}function c(e,t=0){return new d(0x10000000000*e[t+7]+0x100000000*e[t+6]+0x1000000*e[t+5]+65536*e[t+4]+256*e[t+3]+e[t+2],e[t+1]<<8|e[t])}class u{constructor(e,t,i,n){this.minv=e,this.maxv=t,this.bin=i,this._fetchedSize=n}toUniqueString(){return`${this.minv}..${this.maxv} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(e){return this.minv.compareTo(e.minv)||this.maxv.compareTo(e.maxv)||this.bin-e.bin}fetchedSize(){return void 0!==this._fetchedSize?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}class m{constructor({filehandle:e,renameRefSeqs:t=e=>e}){this.filehandle=e,this.renameRefSeq=t}async getMetadata(e={}){let{indices:t,...i}=await this.parse(e);return i}_findFirstData(e,t){return e?e.compareTo(t)>0?t:e:t}async parse(e={}){return this.parseP||(this.parseP=this._parse(e).catch(e=>{throw this.parseP=void 0,e})),this.parseP}async hasRefSeq(e,t={}){let i=await this.parse(t);return!!i.indices[e]?.binIndex}}function p(e,t=0){let i=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24;return((e[t+4]|e[t+5]<<8|e[t+6]<<16|e[t+7]<<24)>>>0)*0x100000000+(i>>>0)}class g extends m{async lineCount(e,t={}){let i=await this.parse(t),n=i.refNameToId[e];return void 0!==n&&i.indices[n]?i.indices[n].stats?.lineCount??-1:-1}async _parse(e={}){let t,i=await this.filehandle.readFile(e),n=await (0,l.unzip)(i);h(e.signal);let r=new DataView(n.buffer);if(0x1494254!==r.getUint32(0,!0))throw Error("Not a TBI file");let a=r.getUint32(4,!0),s=r.getUint32(8,!0),o={0:"generic",1:"SAM",2:"VCF"}[15&s];if(!o)throw Error(`invalid Tabix preset format flags ${s}`);let f={ref:r.getInt32(12,!0),start:r.getInt32(16,!0),end:r.getInt32(20,!0)},d=r.getInt32(24,!0),m=d?String.fromCharCode(d):null,p=r.getInt32(28,!0),g=r.getInt32(32,!0),{refNameToId:x,refIdToName:b}=this._parseNameBytes(n.slice(36,36+g)),w=36+g;return{indices:Array(a).fill(0).map(()=>{let e,i=r.getInt32(w,!0);w+=4;let a={};for(let s=0;s<i;s+=1){let i=r.getUint32(w,!0);if(w+=4,i>37450)throw Error("tabix index contains too many bins, please use a CSI index");if(37450===i){let t=r.getInt32(w,!0);w+=4,2===t&&(e=this.parsePseudoBin(n,w)),w+=16*t}else{let e=r.getInt32(w,!0);w+=4;let s=Array(e);for(let r=0;r<e;r+=1){let e=c(n,w),a=c(n,w+8);w+=16,t=this._findFirstData(t,e),s[r]=new u(e,a,i)}a[i]=s}}let s=r.getInt32(w,!0);w+=4;let l=Array(s);for(let e=0;e<s;e+=1)l[e]=c(n,w),w+=8,t=this._findFirstData(t,l[e]);return{binIndex:a,linearIndex:l,stats:e}}),metaChar:m,maxBinNumber:37449,maxRefLength:0x20000000,skipLines:p,firstDataLine:t,columnNumbers:f,coordinateType:65536&s?"zero-based-half-open":"1-based-closed",format:o,refIdToName:b,refNameToId:x,maxBlockSize:65536}}parsePseudoBin(e,t){return{lineCount:p(e,t+16)}}_parseNameBytes(e){let t=0,i=0,n=[],r={},a=new TextDecoder("utf8");for(let s=0;s<e.length;s+=1)if(!e[s]){if(i<s){let l=this.renameRefSeq(a.decode(e.subarray(i,s)));n[t]=l,r[l]=t}i=s+1,t+=1}return{refNameToId:r,refIdToName:n}}async blocksForRange(e,t,i,n={}){var r,a;t<0&&(t=0);let s=await this.parse(n),l=s.refNameToId[e];if(void 0===l)return[];let o=s.indices[l];if(!o)return[];(o.linearIndex.length?o.linearIndex[t>>14>=o.linearIndex.length?o.linearIndex.length-1:t>>14]:new d(0,0))||console.warn("querying outside of possible tabix range");let h=[[0,0],[1+((r=t+1)>>26),1+((a=i-1)>>26)],[9+(r>>23),9+(a>>23)],[73+(r>>20),73+(a>>20)],[585+(r>>17),585+(a>>17)],[4681+(r>>14),4681+(a>>14)]],c=[];for(let[e,t]of h)for(let i=e;i<=t;i++)if(o.binIndex[i])for(let e of o.binIndex[i])c.push(new u(e.minv,e.maxv,i));let m=o.linearIndex.length,p=null,g=Math.min(t>>14,m-1),x=Math.min(i>>14,m-1);for(let e=g;e<=x;++e){let t=o.linearIndex[e];t&&(!p||0>t.compareTo(p))&&(p=t)}return f(c,p)}}let x={0:"generic",1:"SAM",2:"VCF"};function b(e,t){return Math.floor(e/2**t)}class w extends m{constructor(e){super(e),this.maxBinNumber=0,this.depth=0,this.minShift=0}async lineCount(e,t={}){let i=await this.parse(t),n=i.refNameToId[e];if(void 0===n||!i.indices[n])return -1;let{stats:r}=i.indices[n];return r?r.lineCount:-1}indexCov(){throw Error("CSI indexes do not support indexcov")}parseAuxData(e,t){let i=new DataView(e.buffer),n=i.getInt32(t,!0),r=x[15&n];if(!r)throw Error(`invalid Tabix preset format flags ${n}`);let a={ref:i.getInt32(t+4,!0),start:i.getInt32(t+8,!0),end:i.getInt32(t+12,!0)},s=i.getInt32(t+16,!0),l=s?String.fromCharCode(s):null,o=i.getInt32(t+20,!0),h=i.getInt32(t+24,!0),{refIdToName:f,refNameToId:d}=this._parseNameBytes(e.subarray(t+28,t+28+h));return{refIdToName:f,refNameToId:d,skipLines:o,metaChar:l,columnNumbers:a,format:r,coordinateType:65536&n?"zero-based-half-open":"1-based-closed"}}_parseNameBytes(e){let t=0,i=0,n=[],r={},a=new TextDecoder("utf8");for(let s=0;s<e.length;s+=1)if(!e[s]){if(i<s){let l=this.renameRefSeq(a.decode(e.subarray(i,s)));n[t]=l,r[l]=t}i=s+1,t+=1}return{refNameToId:r,refIdToName:n}}async _parse(e={}){let t,i,n=await (0,l.unzip)(await this.filehandle.readFile(e)),r=new DataView(n.buffer);if(0x1495343===r.getUint32(0,!0))t=1;else if(0x2495343===r.getUint32(0,!0))t=2;else throw Error("Not a CSI file");this.minShift=r.getInt32(4,!0),this.depth=r.getInt32(8,!0),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;let a=2**(this.minShift+3*this.depth),s=r.getInt32(12,!0),o=s&&s>=30?this.parseAuxData(n,16):{refIdToName:[],refNameToId:{},metaChar:null,columnNumbers:{ref:0,start:1,end:2},coordinateType:"zero-based-half-open",format:"generic"},h=r.getInt32(16+s,!0),f=16+s+4,d=Array(h).fill(0).map(()=>{let e,t=r.getInt32(f,!0);f+=4;let a={};for(let s=0;s<t;s+=1){let t=r.getUint32(f,!0);if(t>this.maxBinNumber)e=this.parsePseudoBin(n,f+4),f+=48;else{let e=c(n,f+4);i=this._findFirstData(i,e);let s=r.getInt32(f+12,!0);f+=16;let l=Array(s);for(let e=0;e<s;e+=1){let i=c(n,f),r=c(n,f+8);f+=16,l[e]=new u(i,r,t)}a[t]=l}}return{binIndex:a,stats:e}});return{...o,csi:!0,refCount:h,maxBlockSize:65536,firstDataLine:i,csiVersion:t,indices:d,depth:this.depth,maxBinNumber:this.maxBinNumber,maxRefLength:a}}parsePseudoBin(e,t){return{lineCount:p(e,t+28)}}async blocksForRange(e,t,i,n={}){t<0&&(t=0);let r=await this.parse(n),a=r.refNameToId[e];if(void 0===a)return[];let s=r.indices[a];if(!s)return[];let l=this.reg2bins(t,i),o=[];for(let[e,t]of l)for(let i=e;i<=t;i++)if(s.binIndex[i])for(let e of s.binIndex[i])o.push(new u(e.minv,e.maxv,i));return f(o,new d(0,0))}reg2bins(e,t){var i;(e-=1)<1&&(e=1),t>0x4000000000000&&(t=0x400000000),t-=1;let n=0,r=0,a=this.minShift+3*this.depth,s=[];for(;n<=this.depth;a-=3,r+=(i=3*n,+(2**i)),n+=1){let i=r+b(e,a),n=r+b(t,a);if(n-i+s.length>this.maxBinNumber)throw Error(`query ${e}-${t} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);s.push([i,n])}return s}}class v{constructor({path:e,filehandle:t,url:i,tbiPath:r,tbiUrl:l,tbiFilehandle:o,csiPath:h,csiUrl:f,csiFilehandle:d,renameRefSeqs:c=e=>e,chunkCacheSize:u=5242880}){if(t)this.filehandle=t;else if(e)this.filehandle=new s.LocalFile(e);else if(i)this.filehandle=new s.RemoteFile(i);else throw TypeError("must provide either filehandle or path");if(o)this.index=new g({filehandle:o,renameRefSeqs:c});else if(d)this.index=new w({filehandle:d,renameRefSeqs:c});else if(r)this.index=new g({filehandle:new s.LocalFile(r),renameRefSeqs:c});else if(h)this.index=new w({filehandle:new s.LocalFile(h),renameRefSeqs:c});else if(e)this.index=new g({filehandle:new s.LocalFile(`${e}.tbi`),renameRefSeqs:c});else if(f)this.index=new w({filehandle:new s.RemoteFile(f)});else if(l)this.index=new g({filehandle:new s.RemoteFile(l)});else if(i)this.index=new g({filehandle:new s.RemoteFile(`${i}.tbi`)});else throw TypeError("must provide one of tbiFilehandle, tbiPath, csiFilehandle, csiPath, tbiUrl, csiUrl");this.renameRefSeq=c,this.chunkCache=new n.A({cache:new(a())({maxSize:Math.floor(u/65536)}),fill:(e,t)=>this.readChunk(e,{signal:t})})}async getLines(e,t,i,n){let r,a,s={};"function"==typeof n?a=n:(s=n,a=n.lineCallback,r=n.signal);let l=await this.index.getMetadata(s);h(r);let o=t??0,f=i??l.maxRefLength;if(!(o<=f))throw TypeError("invalid start and end coordinates. start must be less than or equal to end");if(o===f)return;let d=await this.index.blocksForRange(e,o,f,s);h(r);let c=new TextDecoder("utf8");for(let t of d){let{buffer:i,cpositions:n,dpositions:s}=await this.chunkCache.get(t.toString(),t,r);h(r);let d=0,u=0,m=c.decode(i),p=/^[\u0000-\u007F]*$/.test(m);for(;d<m.length;){let r,h;if(p){if(-1===(h=m.indexOf("\n",d)))break;r=m.slice(d,h)}else{if(-1===(h=i.indexOf(10,d)))break;let e=i.slice(d,h);r=c.decode(e)}if(s){for(;d+t.minv.dataPosition>=s[u++];);u--}let{startCoordinate:g,overlaps:x}=this.checkLine(l,e,o,f,r);if(x)a(r,256*n[u]+(d-s[u])+t.minv.dataPosition+1);else if(void 0!==g&&g>=f)return;d=h+1}}}async getMetadata(e={}){return this.index.getMetadata(e)}async getHeaderBuffer(e={}){let{firstDataLine:t,metaChar:i,maxBlockSize:n}=await this.getMetadata(e);h(e.signal);let r=(t?.blockPosition||0)+n,a=await this.filehandle.read(r,0,e),s=await (0,l.unzip)(a);if(i){let e=-1,t=i.charCodeAt(0);for(let i=0;i<s.length&&(i!==e+1||s[i]===t);i+=1)10===s[i]&&(e=i);return s.subarray(0,e+1)}return s}async getHeader(e={}){let t=new TextDecoder("utf8"),i=await this.getHeaderBuffer(e);return t.decode(i)}async getReferenceSequenceNames(e={}){return(await this.getMetadata(e)).refIdToName}checkLine(e,t,i,n,r){let{columnNumbers:a,metaChar:s,coordinateType:l,format:o}=e;if(s&&r.startsWith(s))return{overlaps:!1};let{ref:h,start:f,end:d}=a;h||(h=0),f||(f=0),d||(d=0),"VCF"===o&&(d=8);let c=Math.max(h,f,d),u=1,m=0,p="",g=-1/0,x=r.length;for(let e=0;e<x+1;e++)if("	"===r[e]||e===x){if(u===h){if(this.renameRefSeq(r.slice(m,e))!==t)return{overlaps:!1}}else if(u===f){if(g=parseInt(r.slice(m,e),10),"1-based-closed"===l&&(g-=1),g>=n||(0===d||d===f)&&g+1<=i)return{startCoordinate:g,overlaps:!1}}else if("VCF"===o&&4===u)p=r.slice(m,e);else if(u===d&&("VCF"===o?this._getVcfEnd(g,p,r.slice(m,e)):Number.parseInt(r.slice(m,e),10))<=i)return{overlaps:!1};if(m=e+1,(u+=1)>c)break}return{startCoordinate:g,overlaps:!0}}_getVcfEnd(e,t,i){let n=e+t.length,r=i.includes("SVTYPE=TRA");if("."===i[0]||r){if(r)return e+1}else{let e=";";for(let t=0;t<i.length;t+=1){if(";"===e&&"END="===i.slice(t,t+4)){let e=i.indexOf(";",t);-1===e&&(e=i.length),n=parseInt(i.slice(t+4,e),10);break}e=i[t]}}return n}async lineCount(e,t={}){return this.index.lineCount(e,t)}async readChunk(e,t={}){let i=await this.filehandle.read(e.fetchedSize(),e.minv.blockPosition,t);return(0,l.unzipChunkSlice)(i,e)}}}}]);
//# sourceMappingURL=8434.0dab1f5b90cb77d1.js.map