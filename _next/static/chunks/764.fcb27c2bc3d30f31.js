"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[764],{60998:(e,t,r)=>{r.d(t,{j9:()=>F,Wg:()=>M});class i{constructor(e,t){this.blockPosition=e,this.dataPosition=t}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(e){return this.blockPosition-e.blockPosition||this.dataPosition-e.dataPosition}static min(...e){let t;let r=0;for(;!t;r+=1)t=e[r];for(;r<e.length;r+=1)t.compareTo(e[r])>0&&(t=e[r]);return t}}function a(e,t=0,r=!1){if(r)throw Error("big-endian virtual file offsets not implemented");return new i(0x10000000000*e[t+7]+0x100000000*e[t+6]+0x1000000*e[t+5]+65536*e[t+4]+256*e[t+3]+e[t+2],e[t+1]<<8|e[t])}class s{constructor(e,t,r,i){this.minv=e,this.maxv=t,this.bin=r,this._fetchedSize=i}toUniqueString(){return`${this.minv.toString()}..${this.maxv.toString()} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(e){return this.minv.compareTo(e.minv)||this.maxv.compareTo(e.maxv)||this.bin-e.bin}fetchedSize(){return void 0!==this._fetchedSize?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}var n=r(92952),d=r.n(n);function o(e,t){let r;let i=[];if(0===e.length)return e;for(let s of(e.sort((e,t)=>{let r=e.minv.blockPosition-t.minv.blockPosition;return 0===r?e.minv.dataPosition-t.minv.dataPosition:r}),e))if(!t||s.maxv.compareTo(t)>0){if(void 0===r)i.push(s),r=s;else{var a;(a=r,s.minv.blockPosition-a.maxv.blockPosition<65e3&&s.maxv.blockPosition-a.minv.blockPosition<5e6)?s.maxv.compareTo(r.maxv)>0&&(r.maxv=s.maxv):(i.push(s),r=s)}}return i}function l(e,t){return{lineCount:d().fromBytesLE(Array.prototype.slice.call(e,t,t+8),!0).toNumber()}}function h(e,t){return e?e.compareTo(t)>0?t:e:t}class f{constructor({filehandle:e,renameRefSeq:t=e=>e}){this.filehandle=e,this.renameRefSeq=t}}class c extends f{async lineCount(e,t){var r,i;return(null===(i=null===(r=(await this.parse(t)).indices[e])||void 0===r?void 0:r.stats)||void 0===i?void 0:i.lineCount)||0}async _parse(e){let t;let r=await this.filehandle.readFile(e);if(0x1494142!==r.readUInt32LE(0))throw Error("Not a BAI file");let i=r.readInt32LE(4),n=8,d=Array(i);for(let e=0;e<i;e++){let i;let o=r.readInt32LE(n);n+=4;let f={};for(let e=0;e<o;e+=1){let e=r.readUInt32LE(n);if(n+=4,37450===e)n+=4,i=l(r,n+16),n+=32;else if(e>37450)throw Error("bai index contains too many bins, please use CSI");else{let i=r.readInt32LE(n);n+=4;let d=Array(i);for(let o=0;o<i;o++){let i=a(r,n),l=a(r,n+=8);n+=8,t=h(t,i),d[o]=new s(i,l,e)}f[e]=d}}let c=r.readInt32LE(n);n+=4;let u=Array(c);for(let e=0;e<c;e++){let i=a(r,n);n+=8,t=h(t,i),u[e]=i}d[e]={binIndex:f,linearIndex:u,stats:i}}return{bai:!0,firstDataLine:t,maxBlockSize:65536,indices:d,refCount:i}}async indexCov(e,t,r,i={}){let a=(await this.parse(i)).indices[e];if(!a)return[];let{linearIndex:s=[],stats:n}=a;if(0===s.length)return[];let d=void 0===r?(s.length-1)*16384:r-r%16384+16384,o=void 0===t?0:t-t%16384,l=void 0!==t?Array((d-o)/16384):Array(s.length-1),h=s[s.length-1].blockPosition;if(d>(s.length-1)*16384)throw Error("query outside of range of linear index");let f=s[o/16384].blockPosition;for(let e=o/16384,t=0;e<d/16384;e++,t++)l[t]={score:s[e+1].blockPosition-f,start:16384*e,end:16384*e+16384},f=s[e+1].blockPosition;return l.map(e=>({...e,score:e.score*((null==n?void 0:n.lineCount)||0)/h}))}async blocksForRange(e,t,r,i={}){var a,n;let d;t<0&&(t=0);let l=await this.parse(i);if(!l)return[];let h=l.indices[e];if(!h)return[];let f=[[0,0],[1+((a=t)>>26),1+((n=r-1)>>26)],[9+(a>>23),9+(n>>23)],[73+(a>>20),73+(n>>20)],[585+(a>>17),585+(n>>17)],[4681+(a>>14),4681+(n>>14)]],c=[];for(let[e,t]of f)for(let r=e;r<=t;r++)if(h.binIndex[r])for(let e of h.binIndex[r])c.push(new s(e.minv,e.maxv,r));let u=h.linearIndex.length,x=Math.min(t>>14,u-1),b=Math.min(r>>14,u-1);for(let e=x;e<=b;++e){let t=h.linearIndex[e];t&&(!d||0>t.compareTo(d))&&(d=t)}return o(c,d)}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async hasRefSeq(e,t={}){var r;return!!(null===(r=(await this.parse(t)).indices[e])||void 0===r?void 0:r.binIndex)}}var u=r(75927),x=r(22238),b=r(91986),g=r(82485),m=r(28126),p=r(68134),y=r.n(p);function _(e,t){return Math.floor(e/2**t)}class w extends f{constructor(){super(...arguments),this.maxBinNumber=0,this.depth=0,this.minShift=0}async lineCount(e,t){var r,i;return(null===(i=null===(r=(await this.parse(t)).indices[e])||void 0===r?void 0:r.stats)||void 0===i?void 0:i.lineCount)||0}async indexCov(){return[]}parseAuxData(e,t){let r=e.readInt32LE(t),i={0:"generic",1:"SAM",2:"VCF"}[15&r];if(!i)throw Error(`invalid Tabix preset format flags ${r}`);let a={ref:e.readInt32LE(t+4),start:e.readInt32LE(t+8),end:e.readInt32LE(t+12)},s=e.readInt32LE(t+16),n=s?String.fromCharCode(s):"",d=e.readInt32LE(t+20),o=e.readInt32LE(t+24);return{columnNumbers:a,coordinateType:65536&r?"zero-based-half-open":"1-based-closed",metaValue:s,metaChar:n,skipLines:d,format:i,formatFlags:r,...function(e,t=e=>e){let r=0,i=0,a=[],s={};for(let n=0;n<e.length;n+=1)if(!e[n]){if(i<n){let d=e.toString("utf8",i,n);d=t(d),a[r]=d,s[d]=r}i=n+1,r+=1}return{refNameToId:s,refIdToName:a}}(e.subarray(t+28,t+28+o),this.renameRefSeq)}}async _parse(e){let t,r;let i=await this.filehandle.readFile(e),n=await (0,b.unzip)(i);if(0x1495343===n.readUInt32LE(0))t=1;else if(0x2495343===n.readUInt32LE(0))t=2;else throw Error("Not a CSI file");this.minShift=n.readInt32LE(4),this.depth=n.readInt32LE(8),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;let d=n.readInt32LE(12),o=d>=30?this.parseAuxData(n,16):void 0,f=n.readInt32LE(16+d),c=16+d+4,u=Array(f);for(let e=0;e<f;e++){let t;let i=n.readInt32LE(c);c+=4;let d={};for(let e=0;e<i;e++){let e=n.readUInt32LE(c);if(c+=4,e>this.maxBinNumber)t=l(n,c+28),c+=44;else{r=h(r,a(n,c)),c+=8;let t=n.readInt32LE(c);c+=4;let i=Array(t);for(let d=0;d<t;d+=1){let t=a(n,c),o=a(n,c+=8);c+=8,r=h(r,t),i[d]=new s(t,o,e)}d[e]=i}}u[e]={binIndex:d,stats:t}}return{csiVersion:t,firstDataLine:r,indices:u,refCount:f,csi:!0,maxBlockSize:65536,...o}}async blocksForRange(e,t,r,a={}){t<0&&(t=0);let s=(await this.parse(a)).indices[e];if(!s)return[];let n=this.reg2bins(t,r);if(0===n.length)return[];let d=[];for(let[e,t]of n)for(let r=e;r<=t;r++)if(s.binIndex[r])for(let e of s.binIndex[r])d.push(e);return o(d,new i(0,0))}reg2bins(e,t){var r;(e-=1)<1&&(e=1),t>0x4000000000000&&(t=0x400000000),t-=1;let i=0,a=0,s=this.minShift+3*this.depth,n=[];for(;i<=this.depth;s-=3,a+=(r=3*i,1*2**r),i+=1){let r=a+_(e,s),i=a+_(t,s);if(i-r+n.length>this.maxBinNumber)throw Error(`query ${e}-${t} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);n.push([r,i])}return n}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async hasRefSeq(e,t={}){var r;return!!(null===(r=(await this.parse(t)).indices[e])||void 0===r?void 0:r.binIndex)}}let v={BAM_FPAIRED:1,BAM_FPROPER_PAIR:2,BAM_FUNMAP:4,BAM_FMUNMAP:8,BAM_FREVERSE:16,BAM_FMREVERSE:32,BAM_FREAD1:64,BAM_FREAD2:128,BAM_FSECONDARY:256,BAM_FQCFAIL:512,BAM_FDUP:1024,BAM_FSUPPLEMENTARY:2048},E="=ACMGRSVTWYHKDBN".split(""),I="MIDNSHP=X???????".split("");class A{constructor(e){this.bytes=e.bytes,this.fileOffset=e.fileOffset}get byteArray(){return this.bytes.byteArray}get flags(){return(0xffff0000&this.byteArray.readInt32LE(this.bytes.start+16))>>16}get ref_id(){return this.byteArray.readInt32LE(this.bytes.start+4)}get start(){return this.byteArray.readInt32LE(this.bytes.start+8)}get end(){return this.start+this.length_on_ref}get id(){return this.fileOffset}get mq(){let e=(65280&this.bin_mq_nl)>>8;return 255===e?void 0:e}get score(){return this.mq}get qual(){if(this.isSegmentUnmapped())return;let e=this.b0+this.read_name_length+4*this.num_cigar_ops+this.num_seq_bytes;return this.byteArray.subarray(e,e+this.seq_length)}get strand(){return this.isReverseComplemented()?-1:1}get b0(){return this.bytes.start+36}get name(){return this.byteArray.toString("ascii",this.b0,this.b0+this.read_name_length-1)}get tags(){let{byteArray:e}=this.bytes,t=this.b0+this.read_name_length+4*this.num_cigar_ops+this.num_seq_bytes+this.seq_length,r=this.bytes.end,i={};for(;t<r;){let a=String.fromCharCode(e[t],e[t+1]),s=String.fromCharCode(e[t+2]);if(t+=3,"A"===s)i[a]=String.fromCharCode(e[t]),t+=1;else if("i"===s)i[a]=e.readInt32LE(t),t+=4;else if("I"===s)i[a]=e.readUInt32LE(t),t+=4;else if("c"===s)i[a]=e.readInt8(t),t+=1;else if("C"===s)i[a]=e.readUInt8(t),t+=1;else if("s"===s)i[a]=e.readInt16LE(t),t+=2;else if("S"===s)i[a]=e.readUInt16LE(t),t+=2;else if("f"===s)i[a]=e.readFloatLE(t),t+=4;else if("Z"===s||"H"===s){let s=[];for(;t<=r;){let r=e[t++];if(0!==r)s.push(String.fromCharCode(r));else break}i[a]=s.join("")}else if("B"===s){let r=String.fromCharCode(e[t++]),s=e.readInt32LE(t);if(t+=4,"i"===r){if("CG"===a){let r=[];for(let i=0;i<s;i++){let i=e.readInt32LE(t),a=i>>4,s=I[15&i];r.push(a+s),t+=4}i[a]=r.join("")}else{let r=[];for(let i=0;i<s;i++)r.push(e.readInt32LE(t)),t+=4;i[a]=r}}else if("I"===r){if("CG"===a){let r=[];for(let i=0;i<s;i++){let i=e.readUInt32LE(t),a=i>>4,s=I[15&i];r.push(a+s),t+=4}i[a]=r.join("")}else{let r=[];for(let i=0;i<s;i++)r.push(e.readUInt32LE(t)),t+=4;i[a]=r}}else if("s"===r){let r=[];for(let i=0;i<s;i++)r.push(e.readInt16LE(t)),t+=2;i[a]=r}else if("S"===r){let r=[];for(let i=0;i<s;i++)r.push(e.readUInt16LE(t)),t+=2;i[a]=r}else if("c"===r){let r=[];for(let i=0;i<s;i++)r.push(e.readInt8(t)),t+=1;i[a]=r}else if("C"===r){let r=[];for(let i=0;i<s;i++)r.push(e.readUInt8(t)),t+=1;i[a]=r}else if("f"===r){let r=[];for(let i=0;i<s;i++)r.push(e.readFloatLE(t)),t+=4;i[a]=r}}else{console.error("Unknown BAM tag type",s);break}}return i}isPaired(){return!!(this.flags&v.BAM_FPAIRED)}isProperlyPaired(){return!!(this.flags&v.BAM_FPROPER_PAIR)}isSegmentUnmapped(){return!!(this.flags&v.BAM_FUNMAP)}isMateUnmapped(){return!!(this.flags&v.BAM_FMUNMAP)}isReverseComplemented(){return!!(this.flags&v.BAM_FREVERSE)}isMateReverseComplemented(){return!!(this.flags&v.BAM_FMREVERSE)}isRead1(){return!!(this.flags&v.BAM_FREAD1)}isRead2(){return!!(this.flags&v.BAM_FREAD2)}isSecondary(){return!!(this.flags&v.BAM_FSECONDARY)}isFailedQc(){return!!(this.flags&v.BAM_FQCFAIL)}isDuplicate(){return!!(this.flags&v.BAM_FDUP)}isSupplementary(){return!!(this.flags&v.BAM_FSUPPLEMENTARY)}get cigarAndLength(){if(this.isSegmentUnmapped())return{length_on_ref:0,CIGAR:""};let e=this.num_cigar_ops,t=this.b0+this.read_name_length,r=[],i=this.byteArray.readInt32LE(t),a=i>>4,s=I[15&i];if("S"===s&&a===this.seq_length)return t+=4,a=(i=this.byteArray.readInt32LE(t))>>4,"N"!==(s=I[15&i])&&console.warn("CG tag with no N tag"),{CIGAR:this.tags.CG,length_on_ref:a};{let n=0;for(let d=0;d<e;++d)a=(i=this.byteArray.readInt32LE(t))>>4,s=I[15&i],r.push(a+s),"H"!==s&&"S"!==s&&"I"!==s&&(n+=a),t+=4;return{CIGAR:r.join(""),length_on_ref:n}}}get length_on_ref(){return this.cigarAndLength.length_on_ref}get CIGAR(){return this.cigarAndLength.CIGAR}get num_cigar_ops(){return 65535&this.flag_nc}get read_name_length(){return 255&this.bin_mq_nl}get num_seq_bytes(){return this.seq_length+1>>1}get seq(){let{byteArray:e}=this.bytes,t=this.b0+this.read_name_length+4*this.num_cigar_ops,r=this.num_seq_bytes,i=this.seq_length,a=[],s=0;for(let n=0;n<r;++n){let r=e[t+n];a.push(E[(240&r)>>4]),++s<i&&(a.push(E[15&r]),s++)}return a.join("")}get pair_orientation(){if(!this.isSegmentUnmapped()&&!this.isMateUnmapped()&&this.ref_id===this.next_refid){let e=this.isReverseComplemented()?"R":"F",t=this.isMateReverseComplemented()?"R":"F",r=" ",i=" ";this.isRead1()?(r="1",i="2"):this.isRead2()&&(r="2",i="1");let a=[];return this.template_length>0?(a[0]=e,a[1]=r,a[2]=t,a[3]=i):(a[2]=e,a[3]=r,a[0]=t,a[1]=i),a.join("")}}get bin_mq_nl(){return this.byteArray.readInt32LE(this.bytes.start+12)}get flag_nc(){return this.byteArray.readInt32LE(this.bytes.start+16)}get seq_length(){return this.byteArray.readInt32LE(this.bytes.start+20)}get next_refid(){return this.byteArray.readInt32LE(this.bytes.start+24)}get next_pos(){return this.byteArray.readInt32LE(this.bytes.start+28)}get template_length(){return this.byteArray.readInt32LE(this.bytes.start+32)}toJSON(){let e={};for(let t of Object.keys(this))t.startsWith("_")||"bytes"===t||(e[t]=this[t]);return e}}function S(e,t){let r=Object.getOwnPropertyDescriptor(e.prototype,t);if(!r)throw Error("OH NO, NO PROPERTY DESCRIPTOR");let i=r.get;if(!i)throw Error("OH NO, NOT A GETTER");Object.defineProperty(e.prototype,t,{get(){let e=i.call(this);return Object.defineProperty(this,t,{value:e}),e}})}function P(e){let t=e.split(/\r?\n/),r=[];for(let e of t){let[t,...i]=e.split(/\t/);t&&r.push({tag:t.slice(1),data:i.map(e=>{let t=e.indexOf(":");return{tag:e.slice(0,t),value:e.slice(t+1)}})})}return r}async function R(e){let t=[];for await(let r of e)t=t.concat(r);return t}S(A,"tags"),S(A,"cigarAndLength"),S(A,"seq"),S(A,"qual");class L{read(){throw Error("never called")}stat(){throw Error("never called")}readFile(){throw Error("never called")}close(){throw Error("never called")}}class F{constructor({bamFilehandle:e,bamPath:t,bamUrl:r,baiPath:i,baiFilehandle:a,baiUrl:s,csiPath:n,csiFilehandle:d,csiUrl:o,htsget:l,yieldThreadTime:h=100,renameRefSeqs:f=e=>e}){if(this.htsget=!1,this.featureCache=new m.A({cache:new(y())({maxSize:50}),fill:async(e,t)=>{let{chunk:r,opts:i}=e,{data:a,cpositions:s,dpositions:n}=await this._readChunk({chunk:r,opts:{...i,signal:t}});return this.readBamFeatures(a,s,n,r)}}),this.renameRefSeq=f,e)this.bam=e;else if(t)this.bam=new g.LocalFile(t);else if(r)this.bam=new g.RemoteFile(r);else if(l)this.htsget=!0,this.bam=new L;else throw Error("unable to initialize bam");if(d)this.index=new w({filehandle:d});else if(n)this.index=new w({filehandle:new g.LocalFile(n)});else if(o)this.index=new w({filehandle:new g.RemoteFile(o)});else if(a)this.index=new c({filehandle:a});else if(i)this.index=new c({filehandle:new g.LocalFile(i)});else if(s)this.index=new c({filehandle:new g.RemoteFile(s)});else if(t)this.index=new c({filehandle:new g.LocalFile(`${t}.bai`)});else if(r)this.index=new c({filehandle:new g.RemoteFile(`${r}.bai`)});else if(l)this.htsget=!0;else throw Error("unable to infer index format");this.yieldThreadTime=h}async getHeaderPre(e){let t;let r=function(e={}){return"aborted"in e?{signal:e}:e}(e);if(!this.index)return;let i=await this.index.parse(r),a=i.firstDataLine?i.firstDataLine.blockPosition+65535:void 0;if(a){let e=a+65536,i=await this.bam.read(u.Buffer.alloc(e),0,e,0,r);if(!i.bytesRead)throw Error("Error reading header");t=i.buffer.subarray(0,Math.min(i.bytesRead,a))}else t=await this.bam.readFile(r);let s=await (0,b.unzip)(t);if(0x14d4142!==s.readInt32LE(0))throw Error("Not a BAM file");let n=s.readInt32LE(4);this.header=s.toString("utf8",8,8+n);let{chrToIndex:d,indexToChr:o}=await this._readRefSeqs(n+8,65535,r);return this.chrToIndex=d,this.indexToChr=o,P(this.header)}getHeader(e){return this.headerP||(this.headerP=this.getHeaderPre(e).catch(e=>{throw this.headerP=void 0,e})),this.headerP}async getHeaderText(e={}){return await this.getHeader(e),this.header}async _readRefSeqs(e,t,r){if(e>t)return this._readRefSeqs(e,2*t,r);let{bytesRead:i,buffer:a}=await this.bam.read(u.Buffer.alloc(t+65536),0,t,0,r);if(!i)throw Error("Error reading refseqs from header");let s=await (0,b.unzip)(a.subarray(0,Math.min(i,t))),n=s.readInt32LE(e),d=e+4,o={},l=[];for(let i=0;i<n;i+=1){let a=s.readInt32LE(d),n=this.renameRefSeq(s.toString("utf8",d+4,d+4+a-1)),h=s.readInt32LE(d+a+4);if(o[n]=i,l.push({refName:n,length:h}),(d=d+8+a)>s.length)return console.warn(`BAM header is very big.  Re-fetching ${t} bytes.`),this._readRefSeqs(e,2*t,r)}return{chrToIndex:o,indexToChr:l}}async getRecordsForRange(e,t,r,i){return R(this.streamRecordsForRange(e,t,r,i))}async *streamRecordsForRange(e,t,r,i){var a;await this.getHeader(i);let s=null===(a=this.chrToIndex)||void 0===a?void 0:a[e];if(void 0!==s&&this.index){let e=await this.index.blocksForRange(s,t-1,r,i);yield*this._fetchChunkFeatures(e,s,t,r,i)}else yield[]}async *_fetchChunkFeatures(e,t,r,i,a={}){let{viewAsPairs:s}=a,n=[],d=!1;for(let s of e){let e=await this.featureCache.get(s.toString(),{chunk:s,opts:a},a.signal),o=[];for(let a of e)if(a.ref_id===t){if(a.start>=i){d=!0;break}a.end>=r&&o.push(a)}if(n.push(o),yield o,d)break}(function(e){if(e&&e.aborted){if("undefined"==typeof DOMException){let e=Error("aborted");throw e.code="ERR_ABORTED",e}throw new DOMException("aborted","AbortError")}})(a.signal),s&&(yield this.fetchPairs(t,n,a))}async fetchPairs(e,t,r){let{pairAcrossChr:i,maxInsertSize:a=2e5}=r,s={},n={};t.map(e=>{let t={};for(let r of e){let e=r.name,i=r.id;t[e]||(t[e]=0),t[e]++,n[i]=1}for(let[e,r]of Object.entries(t))1===r&&(s[e]=!0)});let d=[];t.map(t=>{for(let n of t){let t=n.name,o=n.start,l=n.next_pos,h=n.next_refid;this.index&&s[t]&&(i||h===e&&Math.abs(o-l)<a)&&d.push(this.index.blocksForRange(h,l,l+1,r))}});let o=new Map;for(let e of(await Promise.all(d)).flat())o.has(e.toString())||o.set(e.toString(),e);return(await Promise.all([...o.values()].map(async e=>{let{data:t,cpositions:i,dpositions:a,chunk:d}=await this._readChunk({chunk:e,opts:r}),o=[];for(let e of(await this.readBamFeatures(t,i,a,d)))s[e.name]&&!n[e.id]&&o.push(e);return o}))).flat()}async _readRegion(e,t,r={}){let{bytesRead:i,buffer:a}=await this.bam.read(u.Buffer.alloc(t),0,t,e,r);return a.subarray(0,Math.min(i,t))}async _readChunk({chunk:e,opts:t}){let r=await this._readRegion(e.minv.blockPosition,e.fetchedSize(),t),{buffer:i,cpositions:a,dpositions:s}=await (0,b.unzipChunkSlice)(r,e);return{data:i,cpositions:a,dpositions:s,chunk:e}}async readBamFeatures(e,t,r,i){let a=0,s=[],n=0,d=+Date.now();for(;a+4<e.length;){let o=e.readInt32LE(a),l=a+4+o-1;if(r){for(;a+i.minv.dataPosition>=r[n++];);n--}if(l<e.length){let o=new A({bytes:{byteArray:e,start:a,end:l},fileOffset:t.length>0?256*t[n]+(a-r[n])+i.minv.dataPosition+1:x.A.signed(e.slice(a,l))});s.push(o),this.yieldThreadTime&&+Date.now()-d>this.yieldThreadTime&&(await new Promise(e=>setTimeout(e,1)),d=+Date.now())}a=l+1}return s}async hasRefSeq(e){var t,r;let i=null===(t=this.chrToIndex)||void 0===t?void 0:t[e];return void 0!==i&&(null===(r=this.index)||void 0===r?void 0:r.hasRefSeq(i))}async lineCount(e){var t;let r=null===(t=this.chrToIndex)||void 0===t?void 0:t[e];return void 0!==r&&this.index?this.index.lineCount(r):0}async indexCov(e,t,r){var i;if(!this.index)return[];await this.index.parse();let a=null===(i=this.chrToIndex)||void 0===i?void 0:i[e];return void 0===a?[]:this.index.indexCov(a,t,r)}async blocksForRange(e,t,r,i){var a;if(!this.index)return[];await this.index.parse();let s=null===(a=this.chrToIndex)||void 0===a?void 0:a[e];return void 0===s?[]:this.index.blocksForRange(s,t,r,i)}}async function C(e,t){let r=await Promise.all(e.map(async e=>{let{url:r,headers:i}=e;if(r.startsWith("data:"))return u.Buffer.from(r.split(",")[1],"base64");{let{referer:e,...a}=i,s=await fetch(r,{...t,headers:{...null==t?void 0:t.headers,...a}});if(!s.ok)throw Error(`HTTP ${s.status} fetching ${r}: ${await s.text()}`);return u.Buffer.from(await s.arrayBuffer())}}));return u.Buffer.concat(await Promise.all(r.map(e=>(0,b.unzip)(e))))}class M extends F{constructor(e){super({htsget:!0}),this.baseUrl=e.baseUrl,this.trackId=e.trackId}async *streamRecordsForRange(e,t,r,i){var a;let s=`${this.baseUrl}/${this.trackId}`,n=`${s}?referenceName=${e}&start=${t}&end=${r}&format=BAM`,d=null===(a=this.chrToIndex)||void 0===a?void 0:a[e];if(void 0===d)yield[];else{let a=await fetch(n,{...i});if(!a.ok)throw Error(`HTTP ${a.status} fetching ${n}: ${await a.text()}`);let s=await a.json(),o=await C(s.htsget.urls.slice(1),i);yield*this._fetchChunkFeatures([{buffer:o,_fetchedSize:void 0,bin:0,compareTo:()=>0,toUniqueString:()=>`${e}_${t}_${r}`,fetchedSize:()=>0,minv:{dataPosition:0,blockPosition:0,compareTo:()=>0},maxv:{dataPosition:Number.MAX_SAFE_INTEGER,blockPosition:0,compareTo:()=>0},toString:()=>`${e}_${t}_${r}`}],d,t,r,i)}}async _readChunk({chunk:e}){if(!e.buffer)throw Error("expected chunk.buffer in htsget");return{data:e.buffer,cpositions:[],dpositions:[],chunk:e}}async getHeader(e={}){let t=`${this.baseUrl}/${this.trackId}?referenceName=na&class=header`,r=await fetch(t,e);if(!r.ok)throw Error(`HTTP ${r.status} fetching ${t}: ${await r.text()}`);let i=await r.json(),a=await C(i.htsget.urls,e);if(0x14d4142!==a.readInt32LE(0))throw Error("Not a BAM file");let s=a.readInt32LE(4),n=P(a.toString("utf8",8,8+s)),d=[],o={};for(let[e,t]of n.filter(e=>"SQ"===e.tag).entries()){let r="",i=0;for(let e of t.data)"SN"===e.tag?r=e.value:"LN"===e.tag&&(i=+e.value);o[r]=e,d[e]={refName:r,length:i}}return this.chrToIndex=o,this.indexToChr=d,n}}},50764:(e,t,r)=>{r.r(t),r.d(t,{default:()=>b});var i=r(60998),a=r(92766),s=r(54262),n=r(61078),d=r(31177),o=r(72471),l=r(28251),h=r(90287),f=r(18998),c=r(46042),u=r(50324);class x{constructor(e,t,r){this.record=e,this.adapter=t,this.ref=r}id(){return`${this.adapter.id}-${this.record.id}`}get mismatches(){return(0,c.DQ)(this.record.CIGAR,this.record.tags.MD,this.record.seq,this.ref,this.record.qual)}get qual(){var e;return null===(e=this.record.qual)||void 0===e?void 0:e.join(" ")}get(e){return"mismatches"===e?this.mismatches:"qual"===e?this.qual:this.fields[e]}parent(){}children(){}get fields(){let e=this.record,t=this.adapter,r=e.isPaired();return{start:e.start,name:e.name,end:e.end,score:e.score,strand:e.strand,template_length:e.template_length,flags:e.flags,tags:e.tags,refName:t.refIdToName(e.ref_id),CIGAR:e.CIGAR,seq:e.seq,type:"match",pair_orientation:e.pair_orientation,next_ref:r?t.refIdToName(e.next_refid):void 0,next_pos:r?e.next_pos:void 0,next_segment_position:r?`${t.refIdToName(e.next_refid)}:${e.next_pos+1}`:void 0,uniqueId:this.id()}}toJSON(){return{...this.fields,qual:this.qual}}}(0,u.Kt)(x,"fields"),(0,u.Kt)(x,"mismatches");class b extends a.BaseFeatureDataAdapter{constructor(){super(...arguments),this.ultraLongFeatureCache=new n.default({maxSize:500})}async configurePre(){let e=this.getConf("bamLocation"),t=this.getConf(["index","location"]),r=this.getConf(["index","indexType"]),a=this.pluginManager,s="CSI"===r,n=new i.j9({bamFilehandle:(0,d.openLocation)(e,a),csiFilehandle:s?(0,d.openLocation)(t,a):void 0,baiFilehandle:s?void 0:(0,d.openLocation)(t,a),yieldThreadTime:Number.POSITIVE_INFINITY}),o=this.getConf("sequenceAdapter");if(o&&this.getSubAdapter){let{dataAdapter:e}=await this.getSubAdapter(o);return{bam:n,sequenceAdapter:e}}return{bam:n}}async configure(){return this.configureP||(this.configureP=this.configurePre().catch(e=>{throw this.configureP=void 0,e})),this.configureP}async getHeader(e){let{bam:t}=await this.configure();return t.getHeaderText()}async setupPre(e){let{statusCallback:t=()=>{}}=e||{},{bam:r}=await this.configure();return this.samHeader=await (0,s.updateStatus)("Downloading index",t,async()=>{let e=await r.getHeader(),t=[],i={};return null==e||e.filter(e=>"SQ"===e.tag).forEach((e,r)=>{let a=e.data.find(e=>"SN"===e.tag);if(a){let e=a.value;i[e]=r,t[r]=e}}),{idToName:t,nameToId:i}}),this.samHeader}async setup(e){return this.setupP||(this.setupP=this.setupPre(e).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async getRefNames(e){let{idToName:t}=await this.setup(e);return t}async seqFetch(e,t,r){let{sequenceAdapter:i}=await this.configure();if(!i||!e)return;let a=i.getFeatures({refName:e,start:t,end:r,assemblyName:""}),s=await (0,h._)(a.pipe((0,f.$)())),n="";if(s.sort((e,t)=>e.get("start")-t.get("start")).forEach(e=>{let i=e.get("start"),a=e.get("end"),s=Math.max(t-i,0),d=Math.min(r-i,a-i)-s,o=e.get("seq")||e.get("residues");n+=o.slice(s,s+d)}),n.length!==r-t)throw Error(`sequence fetch failed: fetching ${e}:${(t-1).toLocaleString()}-${r.toLocaleString()} returned ${n.length.toLocaleString()} bases, but should have returned ${(r-t).toLocaleString()}`);return n}getFeatures(e,t){let{refName:r,start:i,end:a,originalRefName:n}=e,{stopToken:d,filterBy:h,statusCallback:f=()=>{}}=t||{};return(0,o.ObservableCreate)(async e=>{let{bam:o}=await this.configure();await this.setup(t),(0,l.checkStopToken)(d);let c=await (0,s.updateStatus)("Downloading alignments",f,()=>o.getRecordsForRange(r,i,a));(0,l.checkStopToken)(d),await (0,s.updateStatus)("Processing alignments",f,async()=>{let{flagInclude:t=0,flagExclude:i=0,tagFilter:a,readName:s}=h||{};for(let d of c){let o;if(d.tags.MD||(o=await this.seqFetch(n||r,d.start,d.end)),(0,u.lE)(d.flags,t,i)||a&&(0,u.Kl)(d.tags[a.tag],a.value)||s&&d.name!==s)continue;let l=this.ultraLongFeatureCache.get(`${d.id}`);if(l)e.next(l);else{let t=new x(d,this,o);this.ultraLongFeatureCache.set(`${d.id}`,t),e.next(t)}}e.complete()})})}async getMultiRegionFeatureDensityStats(e,t){let{bam:r}=await this.configure();return r.index?{bytes:await (0,s.bytesForRegions)(e,r),fetchSizeLimit:this.getConf("fetchSizeLimit")}:super.getMultiRegionFeatureDensityStats(e,t)}freeResources(){}refIdToName(e){var t;return null===(t=this.samHeader)||void 0===t?void 0:t.idToName[e]}}},22238:(e,t,r)=>{r.d(t,{A:()=>n});let i=[0,0x77073096,0xee0e612c,0x990951ba,0x76dc419,0x706af48f,0xe963a535,0x9e6495a3,0xedb8832,0x79dcb8a4,0xe0d5e91e,0x97d2d988,0x9b64c2b,0x7eb17cbd,0xe7b82d07,0x90bf1d91,0x1db71064,0x6ab020f2,0xf3b97148,0x84be41de,0x1adad47d,0x6ddde4eb,0xf4d4b551,0x83d385c7,0x136c9856,0x646ba8c0,0xfd62f97a,0x8a65c9ec,0x14015c4f,0x63066cd9,0xfa0f3d63,0x8d080df5,0x3b6e20c8,0x4c69105e,0xd56041e4,0xa2677172,0x3c03e4d1,0x4b04d447,0xd20d85fd,0xa50ab56b,0x35b5a8fa,0x42b2986c,0xdbbbc9d6,0xacbcf940,0x32d86ce3,0x45df5c75,0xdcd60dcf,0xabd13d59,0x26d930ac,0x51de003a,0xc8d75180,0xbfd06116,0x21b4f4b5,0x56b3c423,0xcfba9599,0xb8bda50f,0x2802b89e,0x5f058808,0xc60cd9b2,0xb10be924,0x2f6f7c87,0x58684c11,0xc1611dab,0xb6662d3d,0x76dc4190,0x1db7106,0x98d220bc,0xefd5102a,0x71b18589,0x6b6b51f,0x9fbfe4a5,0xe8b8d433,0x7807c9a2,0xf00f934,0x9609a88e,0xe10e9818,0x7f6a0dbb,0x86d3d2d,0x91646c97,0xe6635c01,0x6b6b51f4,0x1c6c6162,0x856530d8,0xf262004e,0x6c0695ed,0x1b01a57b,0x8208f4c1,0xf50fc457,0x65b0d9c6,0x12b7e950,0x8bbeb8ea,0xfcb9887c,0x62dd1ddf,0x15da2d49,0x8cd37cf3,0xfbd44c65,0x4db26158,0x3ab551ce,0xa3bc0074,0xd4bb30e2,0x4adfa541,0x3dd895d7,0xa4d1c46d,0xd3d6f4fb,0x4369e96a,0x346ed9fc,0xad678846,0xda60b8d0,0x44042d73,0x33031de5,0xaa0a4c5f,0xdd0d7cc9,0x5005713c,0x270241aa,0xbe0b1010,0xc90c2086,0x5768b525,0x206f85b3,0xb966d409,0xce61e49f,0x5edef90e,0x29d9c998,0xb0d09822,0xc7d7a8b4,0x59b33d17,0x2eb40d81,0xb7bd5c3b,0xc0ba6cad,0xedb88320,0x9abfb3b6,0x3b6e20c,0x74b1d29a,0xead54739,0x9dd277af,0x4db2615,0x73dc1683,0xe3630b12,0x94643b84,0xd6d6a3e,0x7a6a5aa8,0xe40ecf0b,0x9309ff9d,0xa00ae27,0x7d079eb1,0xf00f9344,0x8708a3d2,0x1e01f268,0x6906c2fe,0xf762575d,0x806567cb,0x196c3671,0x6e6b06e7,0xfed41b76,0x89d32be0,0x10da7a5a,0x67dd4acc,0xf9b9df6f,0x8ebeeff9,0x17b7be43,0x60b08ed5,0xd6d6a3e8,0xa1d1937e,0x38d8c2c4,0x4fdff252,0xd1bb67f1,0xa6bc5767,0x3fb506dd,0x48b2364b,0xd80d2bda,0xaf0a1b4c,0x36034af6,0x41047a60,0xdf60efc3,0xa867df55,0x316e8eef,0x4669be79,0xcb61b38c,0xbc66831a,0x256fd2a0,0x5268e236,0xcc0c7795,0xbb0b4703,0x220216b9,0x5505262f,0xc5ba3bbe,0xb2bd0b28,0x2bb45a92,0x5cb36a04,0xc2d7ffa7,0xb5d0cf31,0x2cd99e8b,0x5bdeae1d,0x9b64c2b0,0xec63f226,0x756aa39c,0x26d930a,0x9c0906a9,0xeb0e363f,0x72076785,0x5005713,0x95bf4a82,0xe2b87a14,0x7bb12bae,0xcb61b38,0x92d28e9b,0xe5d5be0d,0x7cdcefb7,0xbdbdf21,0x86d3d2d4,0xf1d4e242,0x68ddb3f8,0x1fda836e,0x81be16cd,0xf6b9265b,0x6fb077e1,0x18b74777,0x88085ae6,0xff0f6a70,0x66063bca,0x11010b5c,0x8f659eff,0xf862ae69,0x616bffd3,0x166ccf45,0xa00ae278,0xd70dd2ee,0x4e048354,0x3903b3c2,0xa7672661,0xd06016f7,0x4969474d,0x3e6e77db,0xaed16a4a,0xd9d65adc,0x40df0b66,936918e3,0xa9bcae53,0xdebb9ec5,0x47b2cf7f,0x30b5ffe9,0xbdbdf21c,0xcabac28a,0x53b39330,0x24b4a3a6,0xbad03605,0xcdd70693,0x54de5729,0x23d967bf,0xb3667a2e,0xc4614ab8,0x5d681b02,0x2a6f2b94,0xb40bbe37,0xc30c8ea1,0x5a05df1b,0x2d02ef8d];"undefined"!=typeof Int32Array&&(i=new Int32Array(i));var a=r(75927);let s=(e,t)=>a.Buffer.from(e,t),n=function(e,t){let r=(e,r)=>t(s(e),r)>>>0;return r.signed=(e,r)=>t(s(e),r),r.unsigned=r,r.model=e,r}("crc-32",(e,t)=>{let r=0===t?0:-1^~~t;for(let t=0;t<e.length;t++)r=i[(r^e[t])&255]^r>>>8;return -1^r})}}]);
//# sourceMappingURL=764.fcb27c2bc3d30f31.js.map