"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2438],{62438:(e,t,r)=>{r.r(t),r.d(t,{default:()=>v});var n=r(92766),i=r(72471),s=r(61550),a=r(90287),o=r(18998),l=r(39554),d=r(54262),f=r(28251);function p(e){return"softclip"===e||"hardclip"===e||"insertion"===e}function c(e,t,r,n){let i=e[r][n];void 0===i&&(i=e[r][n]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),i.entryDepth++,i[t]++}function u(e,t,r,n,i){let s=e[r][n];void 0===s&&(s=e[r][n]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),s.entryDepth++,s.probabilities.push(i),s[t]++}var h=r(10521),g=r(46042),m=r(87206);async function b({fetchSequence:e,features:t,region:r,opts:n}){let{stopToken:i,colorBy:s}=n,a={},o=[],l=Math.max(0,r.start-1),b=r.start-l,v=performance.now();for(let n of t){if(performance.now()-v>400&&((0,f.checkStopToken)(i),v=performance.now()),!function({feature:e,bins:t,region:r}){let n=e.get("start"),i=e.get("end"),s=e.get("strand"),a=r.end-r.start;for(let e=n;e<i+1;e++){let n=e-r.start;n>=0&&n<a&&(void 0===t[n]&&(t[n]={depth:0,readsCounted:0,ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},snps:{},mods:{},nonmods:{},delskips:{},noncov:{}}),e!==i&&(t[n].depth++,t[n].readsCounted++,t[n].ref.entryDepth++,t[n].ref[s]++))}}({feature:n,bins:o,region:r}),(null==s?void 0:s.type)==="modifications"){let t=await e({...r,start:l,end:r.end+1})||"";!function({feature:e,colorBy:t,region:r,bins:n,regionSequence:i}){var s,a,o;let l=e.get("start"),f=e.get("strand"),p=e.get("end"),c=null===(s=null==t?void 0:t.modifications)||void 0===s?void 0:s.twoColor,g=null===(a=null==t?void 0:t.modifications)||void 0===a?void 0:a.isolatedModification;null===(o=(0,h.r)(e))||void 0===o||o.forEach(({type:e,prob:t,allProbs:s},a)=>{if(g&&e!==g)return;let o=a+l-r.start;if(o>=0&&o<n.length&&a+l<p){void 0===n[o]&&(n[o]={depth:0,readsCounted:0,snps:{},ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},mods:{},nonmods:{},delskips:{},noncov:{}});let r=1-(0,d.sum)(s),a=n[o];a.refbase=i[o],c&&r>(0,d.max)(s)?u(a,f,"nonmods",`nonmod_${e}`,r):u(a,f,"mods",`mod_${e}`,t)}})}({feature:n,colorBy:s,bins:o,region:r,regionSequence:t.slice(b)})}else if((null==s?void 0:s.type)==="methylation"){let t=await e({...r,start:l,end:r.end+1})||"";!function({feature:e,region:t,bins:r,regionSequence:n}){var i;let s=e.get("start"),a=e.get("end"),o=e.get("strand"),l=e.get("seq"),f=null!==(i=e.get("mismatches"))&&void 0!==i?i:[],p=n.toLowerCase();if(l){let n=(0,g.eL)(e.get("CIGAR")),{methBins:i,methProbs:l}=(0,m.Ps)(e,n),c=f.filter(e=>"deletion"===e.type);for(let e=0;e<a-s;e++){let n=e+s,a=p[n-t.start+1],f=p[n-t.start+2];if("c"===a&&"g"===f){let a=r[n-t.start],f=r[n-t.start+1],p=i[e],h=i[e+1],g=l[e],m=l[e+1];p&&(void 0===g||g>.5)||h&&(void 0===m||m>.5)?(a&&(u(a,o,"mods","cpg_meth",g||0),a.ref.entryDepth--,a.ref[o]--),f&&(u(f,o,"mods","cpg_meth",m||0),f.ref.entryDepth--,f.ref[o]--)):(a&&!c.some(e=>(0,d.doesIntersect2)(n,n+1,e.start+s,e.start+s+e.length))&&(u(a,o,"nonmods","cpg_unmeth",1-(g||0)),a.ref.entryDepth--,a.ref[o]--),f&&!c.some(e=>(0,d.doesIntersect2)(n+1,n+2,e.start+s,e.start+s+e.length))&&(u(f,o,"nonmods","cpg_unmeth",1-(m||0)),f.ref.entryDepth--,f.ref[o]--))}}}}({feature:n,bins:o,region:r,regionSequence:t})}!function({feature:e,region:t,bins:r,skipmap:n}){var i;let s=e.get("start"),a=e.get("strand");for(let o of null!==(i=e.get("mismatches"))&&void 0!==i?i:[]){let i=s+o.start,l=p(o.type)?1:o.length,d=i+l;for(let e=i;e<i+l;e++){let n=e-t.start;if(n>=0&&n<r.length){let e=r[n],{base:t,altbase:i,type:s}=o,l=p(s);"deletion"===s||"skip"===s?(c(e,a,"delskips",s),e.depth--):l?c(e,a,"noncov",s):(c(e,a,"snps",t),e.ref.entryDepth--,e.ref[a]--,e.refbase=i)}}if("skip"===o.type){let t=e.get("tags"),r=(null==t?void 0:t.XS)||(null==t?void 0:t.TS),s=null==t?void 0:t.ts,o="+"===r?1:"-"===r?-1:("+"===s?1:"-"===r?-1:0)*a,l=`${i}_${d}_${o}`;void 0===n[l]&&(n[l]={feature:e,start:i,end:d,strand:a,effectiveStrand:o,score:0}),n[l].score++}}}({feature:n,skipmap:a,bins:o,region:r})}for(let e of o)e&&(e.mods=Object.fromEntries(Object.entries(e.mods).map(([e,t])=>[e,{...t,avgProbability:t.probabilities.length?(0,d.sum)(t.probabilities)/t.probabilities.length:void 0}])),e.nonmods=Object.fromEntries(Object.entries(e.nonmods).map(([e,t])=>[e,{...t,avgProbability:t.probabilities.length?(0,d.sum)(t.probabilities)/t.probabilities.length:void 0}])));return{bins:o,skipmap:a}}class v extends n.BaseFeatureDataAdapter{async configure(){var e,t;let r=this.getConf("subadapter"),n=r.sequenceAdapter,i=await (null===(e=this.getSubAdapter)||void 0===e?void 0:e.call(this,r)),s=n?await (null===(t=this.getSubAdapter)||void 0===t?void 0:t.call(this,n)):void 0;if(!i)throw Error("Failed to get subadapter");return{subadapter:i.dataAdapter,sequenceAdapter:null==s?void 0:s.dataAdapter}}async fetchSequence(e){let{sequenceAdapter:t}=await this.configure();if(t)return(0,l.Iw)(e,t)}getFeatures(e,t={}){return(0,i.ObservableCreate)(async r=>{let{subadapter:n}=await this.configure(),i=await (0,a._)(n.getFeatures(e,t).pipe((0,o.$)())),{bins:l,skipmap:d}=await b({features:i,region:e,opts:t,fetchSequence:e=>this.fetchSequence(e)});l.forEach((t,n)=>{let i=e.start+n;r.next(new s.default({id:`${this.id}-${i}`,data:{score:t.depth,snpinfo:t,start:i,end:i+1,refName:e.refName}}))}),Object.entries(d).forEach(([e,t])=>{r.next(new s.default({id:e,data:{type:"skip",start:t.start,end:t.end,strand:t.strand,score:t.score,effectiveStrand:t.effectiveStrand}}))}),r.complete()},t.stopToken)}async getMultiRegionFeatureDensityStats(e,t){let{subadapter:r}=await this.configure();return r.getMultiRegionFeatureDensityStats(e,t)}async getRefNames(e={}){let{subadapter:t}=await this.configure();return t.getRefNames(e)}freeResources(){}}},10521:(e,t,r)=>{r.d(t,{r:()=>o});var n=r(46042),i=r(65802),s=r(87206),a=r(39554);function o(e,t){let r=e.get("strand"),o=e.get("seq"),l=(0,a.c$)(e,"MM","Mm")||"",d=t||(0,n.eL)(e.get("CIGAR"));if(o){let t=(0,s.Z1)(l,o,r),n=(0,s.Yj)(e),a=[],f=0;for(let{type:e,positions:s}of t){for(let{ref:t,idx:o}of(0,i.h)(d,s)){let i=(null==n?void 0:n[f+(-1===r?s.length-1-o:o)])||0;if(a[t]){let r=a[t];a[t]={allProbs:[...r.allProbs,i],prob:Math.max(r.prob,i),type:r.prob>i?r.type:e}}else a[t]={type:e,prob:i,allProbs:[i]}}f+=s.length}return a}}}}]);
//# sourceMappingURL=2438.c75fe385c8b18e27.js.map